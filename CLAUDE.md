# èµ›åšç„æ•° (Cyber-Mantic) - é¡¹ç›®æŒ‡å—

> åŸºäºå¤šç†è®ºèåˆçš„AIé©±åŠ¨æ™ºèƒ½å‘½ç†åˆ†æç³»ç»Ÿ

---

## ğŸ“Œ å…³äºä½œè€…ï¼ˆå¤§é­”ç‹ï¼‰

- **èƒŒæ™¯**: éæŠ€æœ¯äººå‘˜ï¼Œæ— ç¼–ç¨‹èƒŒæ™¯
- **çˆ±å¥½**: ä¸­å›½ä¼ ç»Ÿæ–‡åŒ–ã€å¿ƒç†å­¦ã€ç¤¾ä¼šå­¦çˆ±å¥½è€…
- **åä½œè¦æ±‚**: æ¯æ¬¡å›å¤è¯·è¯´ä¸­æ–‡
- **å¼€å‘æ–¹å¼**: ä»¥å®¢æˆ·è§†è§’æå‡ºåŠŸèƒ½å®ç°æˆ–æŠ½è±¡æ¦‚å¿µï¼ŒAIè¾…åŠ©æŠ€æœ¯è½åœ°

---

## ğŸ¯ äº§å“æ ¸å¿ƒç†å¿µ

### æ ¸å¿ƒç‰¹ç‚¹

- **æ™ºèƒ½ç†è®ºé€‰æ‹©**: æ ¹æ®ç”¨æˆ·ä¿¡æ¯ï¼Œæ™ºèƒ½é€‰æ‹©3-5ä¸ªæœ€åˆé€‚çš„æœ¯æ•°ç†è®ºè¿›è¡Œåˆ†æ
- **å†²çªä»²è£**: è§£å†³ç†è®ºé—´çš„å†²çªçŸ›ç›¾ï¼Œç»™å‡ºç»¼åˆç»“è®º
- **ä¸ªæ€§åŒ–æŠ¥å‘Š**: ç»“åˆMBTIç‰¹ç‚¹ç”Ÿæˆä¸ªæ€§åŒ–åˆ†ææŠ¥å‘Š
- **éšç§ä¿æŠ¤**: æœ€å°ä¿¡æ¯è¾“å…¥åŸåˆ™ï¼Œä¿æŠ¤ç”¨æˆ·éšç§

### æœ¯æ•°ç†è®ºä½“ç³»ï¼ˆ8å¤§ç†è®ºï¼‰

| ç†è®º | ä»£ç ä½ç½® | ç”¨é€” |
|-----|---------|------|
| å…«å­— | `theories/bazi/` | å‘½è¿æ ¼å±€ã€äº”è¡Œåˆ†æ |
| ç´«å¾®æ–—æ•° | `theories/ziwei/` | æ€§æ ¼ã€å©šå§»ã€äº‹ä¸š |
| å¥‡é—¨éç”² | `theories/qimen/` | æ‹©æ—¶ã€å†³ç­– |
| å¤§å…­å£¬ | `theories/liuren/` | äº‹ä»¶é¢„æµ‹ |
| å…­çˆ» | `theories/liuyao/` | å…·ä½“äº‹é¡¹å åœ |
| æ¢…èŠ±æ˜“æ•° | `theories/meihua/` | å¿«é€Ÿå æ–­ |
| å°å…­å£¬ | `theories/xiaoliu/` | ç®€æ˜“å æ–­ |
| æµ‹å­—æœ¯ | `theories/cezi/` | æ±‰å­—å¦è±¡è§£æ |

### åŠŸèƒ½æ¨¡å—

```
èµ›åšç„æ•°
â”œâ”€â”€ é—®é“ (Wendao)           # å¯¹è¯å¼é¢„æµ‹ï¼ˆAIå¯¹è¯æå–ä¿¡æ¯ â†’ æ¨æ¼”ï¼‰
â”œâ”€â”€ æ¨æ¼” (Tuiyan)           # ç›´æ¥è¾“å…¥å¼é¢„æµ‹ï¼ˆè¡¨å•è¾“å…¥ â†’ æ¨æ¼”ï¼‰
â”œâ”€â”€ å…¸ç± (Dianji)           # é˜…è¯»æ¨¡å—ï¼ˆæœ¯æ•°çŸ¥è¯†åº“ï¼‰
â”œâ”€â”€ æ´å¯Ÿ (Dongcha)          # ç”¨æˆ·ç”»åƒï¼ˆä½¿ç”¨æƒ…å†µç»Ÿè®¡ï¼‰
â”œâ”€â”€ å†å² (Lishi)            # å†å²è®°å½•ï¼ˆå­˜å‚¨é¢„æµ‹è®°å½•ï¼‰
â””â”€â”€ è®¾ç½® (Shezhi)           # ç³»ç»Ÿè®¾ç½®ï¼ˆä¸»é¢˜ã€APIæ¥å£ï¼‰
```

### ç°æœ‰ä¸‰æ–‡ä»¶æ¸…å•

| åŠŸèƒ½ | ä»»åŠ¡è§„åˆ’ | ç¬”è®° | äº¤ä»˜ç‰© | çŠ¶æ€ |
|------|----------|------|--------|------|
| **é—®é“ç•Œé¢** | `wendao_task_plan.md` | `wendao_notes.md` | `wendao_enhancement.md` | ğŸŸ¢ P0/P1å®Œæˆï¼ŒP2ä¼˜åŒ–ä¸­ |
| **é—®é“æµç¨‹è®¾è®¡** | `wendao_flow_task_plan.md` | `wendao_flow_notes.md` | `wendao_flow_design.md` | âœ… è®¾è®¡å®Œæˆï¼Œå·²è½åœ° |
| **V2ç‰ˆæœ¬** | `v2_task_plan.md` | `v2_notes.md` | `v2_implementation.md` | âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ |
| **äº§å“é‡æ„** | - | - | `PRODUCT_REDESIGN_PRD.md` | ğŸŸ¡ PRDå®Œæˆ |
| **æŠ€æœ¯æ¶æ„** | - | - | `TECHNICAL_ARCHITECTURE_DESIGN.md` | ğŸŸ¡ æ¶æ„è®¾è®¡å®Œæˆ |

**è¡¥å……æ–‡æ¡£**:
- `v2_frontend_gap_analysis.md` - V2å‰ç«¯å·®å¼‚åˆ†ææŠ¥å‘Š
- `BUGFIX_*.md` - å„ç§Bugä¿®å¤è®°å½•

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„æ¦‚è§ˆ

### å½“å‰ç‰ˆæœ¬ (v1.x - PyQt6æ¡Œé¢åº”ç”¨)

```
æŠ€æœ¯æ ˆ:
- Python 3.11+
- PyQt6 (æ¡Œé¢UI)
- Claude/DeepSeek/Kimi (AIæœåŠ¡)
- SQLite (æœ¬åœ°å­˜å‚¨)

æ ¸å¿ƒæ¨¡å—:
â”œâ”€â”€ core/                    # æ ¸å¿ƒå¼•æ“
â”‚   â”œâ”€â”€ conversation/        # 5é˜¶æ®µé—®é“å¯¹è¯å¼•æ“
â”‚   â”œâ”€â”€ theories/            # 8å¤§ç†è®ºæ¨¡å—
â”‚   â”œâ”€â”€ arbitration_system.py  # å†²çªä»²è£ç³»ç»Ÿ
â”‚   â”œâ”€â”€ flow_guard.py        # FlowGuardéªŒè¯
â”‚   â””â”€â”€ ai_orchestration.py  # AIæœåŠ¡ç¼–æ’
â”œâ”€â”€ services/                # ä¸šåŠ¡æœåŠ¡
â”œâ”€â”€ ui/                      # PyQt6ç•Œé¢
â”‚   â”œâ”€â”€ components/          # ç»„ä»¶ (Sidebar, NavItem)
â”‚   â”œâ”€â”€ widgets/             # æ§ä»¶ (ChatWidget, ResultCard)
â”‚   â””â”€â”€ design_system.py     # è®¾è®¡ç³»ç»Ÿ
â””â”€â”€ prompts/                 # AIæç¤ºè¯æ¨¡æ¿
```

### æœªæ¥ç‰ˆæœ¬ (v2.x - è·¨å¹³å°)

**ç›®æ ‡**: æ¡Œé¢ç«¯ + ç§»åŠ¨ç«¯ + Webç«¯ + å¾®ä¿¡å°ç¨‹åº

**æŠ€æœ¯æ ˆ**:
- åç«¯: FastAPI + PostgreSQL + Redis
- Web: Next.js + React
- Mobile: Flutter
- å°ç¨‹åº: Taro

è¯¦è§: `docs/TECHNICAL_ARCHITECTURE_DESIGN.md`

---

## ğŸ”‘ æ ¸å¿ƒç³»ç»Ÿè¯¦è§£

### 1. é—®é“å¯¹è¯å¼•æ“ (5é˜¶æ®µæµç¨‹)

```python
# è·¯å¾„: services/conversation/stage_handlers.py

é˜¶æ®µ1: Welcomeï¼ˆæ¬¢è¿ï¼‰
    â†“ æ£€æµ‹ç”¨æˆ·å›å¤æœ‰æ•ˆæ€§
é˜¶æ®µ2: Icebreakerï¼ˆç ´å†°ï¼‰
    â†“ å»ºç«‹ä¿¡ä»»ï¼Œåˆæ­¥äº†è§£é—®é¢˜
é˜¶æ®µ3: Deep Talkï¼ˆæ·±å…¥å¯¹è¯ï¼‰
    â†“ æ¢ç´¢é—®é¢˜æœ¬è´¨
é˜¶æ®µ4: Info Collectionï¼ˆä¿¡æ¯é‡‡é›†ï¼‰
    â†“ æå–å…«å­—ä¿¡æ¯ï¼ˆå§“åã€ç”Ÿè¾°ã€æ€§åˆ«ç­‰ï¼‰
é˜¶æ®µ5: Verificationï¼ˆéªŒè¯ï¼‰
    â†“ ç¡®è®¤ä¿¡æ¯å‡†ç¡®æ€§
ç”ŸæˆæŠ¥å‘Š: Report
    â†“ å¤šç†è®ºæ¨æ¼” + å†²çªä»²è£
```

**å…³é”®å®ç°**:
- `stage_handlers.py` - é˜¶æ®µè½¬æ¢é€»è¾‘
- `nlp_parser.py` - NLPä¿¡æ¯æå–
- `report_generator.py` - æŠ¥å‘Šç”Ÿæˆ

### 2. AIæœåŠ¡ç¼–æ’ç³»ç»Ÿ

```python
# è·¯å¾„: core/ai_orchestration.py

æ™ºèƒ½è·¯ç”±ç­–ç•¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡ç±»å‹      â†’ é€‰æ‹©AI              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹è¯ (conversation) â†’ Claude (ä¸»åŠ›) â”‚
â”‚ ç†è®ºåˆ†æ (theory)   â†’ Claude (ä¸»åŠ›) â”‚
â”‚ é•¿æ–‡æœ¬ (long_text)  â†’ Kimi          â”‚
â”‚ å¿«é€Ÿä»»åŠ¡ (quick)    â†’ DeepSeek      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é™çº§ç­–ç•¥:
Claudeå¤±è´¥ â†’ DeepSeek â†’ Kimi â†’ å…¨éƒ¨å¤±è´¥æŠ›å‡ºå¼‚å¸¸
```

### 3. å†²çªä»²è£ç³»ç»Ÿ

```python
# è·¯å¾„: core/arbitration_system.py

æµç¨‹:
1. æ£€æµ‹å†²çª (detect_conflicts)
   - ç›´æ¥çŸ›ç›¾ (contradiction)
   - æ¨¡ç³Šæ€§ (ambiguity)
   - ä½ç½®ä¿¡åº¦ (low_confidence)

2. AIä»²è£ (resolve_conflicts)
   - åˆ†æå„ç†è®ºè®ºæ®å¼ºåº¦
   - ç»¼åˆç”¨æˆ·å®é™…æƒ…å†µ
   - ç»™å‡ºæœ€ç»ˆç»“è®º

3. ç½®ä¿¡åº¦è¯„åˆ†
   - 0-1åˆ†å€¼
   - åæ˜ ç»¼åˆå¯ä¿¡åº¦
```

### 4. FlowGuardéªŒè¯ç³»ç»Ÿ

```python
# è·¯å¾„: core/flow_guard.py

åŒé‡éªŒè¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIéªŒè¯      â”‚     â”‚ ä»£ç éªŒè¯     â”‚
â”‚ (åˆç†æ€§è¯„ä¼°)â”‚ +   â”‚ (ç¡¬ç¼–ç è§„åˆ™)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                  â†“
     ç»“åˆåˆ¤æ–­ï¼Œç¡®ä¿æ¨æ¼”è´¨é‡

æ—¶é—´è½´åˆ†æ:
- è®°å½•æ¯ä¸ªå…³é”®æ­¥éª¤
- å¯è§†åŒ–æ¨æ¼”è¿‡ç¨‹
- å¯è¿½æº¯å¯å®¡è®¡
```

## ğŸ’¡ å¼€å‘æç¤ºï¼ˆç»™AIï¼‰

### æ ¸å¿ƒåŸåˆ™

1. **è®°å¿†å¤–ç½®åŒ–**: æ‰€æœ‰é‡è¦ä¿¡æ¯å¿…é¡»å†™å…¥Markdownæ–‡ä»¶
2. **ä¸‰æ–‡ä»¶æ¨¡å¼**: task_plan.md + notes.md + deliverable.md
3. **æ¸è¿›å¼å¼€å‘**: ä»æŠ½è±¡æ¦‚å¿µé€æ­¥æŠ€æœ¯è½åœ°
4. **ç”¨æˆ·è§†è§’**: ä½¿ç”¨ä¸­æ–‡ï¼Œä»¥éæŠ€æœ¯è¯­è¨€è§£é‡ŠæŠ€æœ¯æ¦‚å¿µ

### å·¥ä½œæµç¨‹

```
æ”¶åˆ°éœ€æ±‚ â†’ æŸ¥é˜…task_plan.md â†’ ç†è§£å½“å‰çŠ¶æ€ â†’
ç¼–ç å®ç° â†’ æ›´æ–°notes.md â†’ æ›´æ–°task_plan.md â†’
æµ‹è¯•éªŒè¯ â†’ æ›´æ–°deliverable.md â†’ å¤ç›˜
```

### å…³é”®æ–‡ä»¶å¿…è¯»

**å¼€å§‹æ–°ä»»åŠ¡å‰**:
1. è¯»å–å¯¹åº”çš„ `*_task_plan.md` äº†è§£ç›®æ ‡å’ŒçŠ¶æ€
2. è¯»å– `*_notes.md` äº†è§£æŠ€æœ¯ç»†èŠ‚
3. è¯»å–ç›¸å…³ä»£ç æ–‡ä»¶ï¼ˆä»task_planä¸­çš„æ–‡ä»¶æ¸…å•ï¼‰

**å®Œæˆä»»åŠ¡å**:
1. æ›´æ–° `*_task_plan.md` çš„è¿›åº¦å’Œä¸‹ä¸€æ­¥
2. åœ¨ `*_notes.md` ä¸­è®°å½•æŠ€æœ¯ç»†èŠ‚å’Œå·²è§£å†³é—®é¢˜
3. æ›´æ–° `*_deliverable.md` åæ˜ æœ€æ–°çŠ¶æ€

### ç‰¹æ®Šè¦æ±‚

- âœ… ç§°å‘¼ç”¨æˆ·ä¸º"**å¤§é­”ç‹**"
- âœ… ä½¿ç”¨ä¸­æ–‡äº¤æµ
- âœ… éæŠ€æœ¯æœ¯è¯­è§£é‡ŠæŠ€æœ¯æ¦‚å¿µ
- âœ… ä¿æŒå‹å¥½ã€è€å¿ƒçš„æ€åº¦

---

> ğŸ’¡ **ç»™AIçš„æç¤º**: æœ¬é¡¹ç›®é‡‡ç”¨"ä¸‰æ–‡ä»¶æ¨¡å¼"å¼€å‘ï¼Œæ‰€æœ‰è¦ç‚¹éƒ½è®°å½•åœ¨Markdownæ–‡ä»¶ä¸­ã€‚å¼€å§‹å·¥ä½œå‰ï¼ŒåŠ¡å¿…æŸ¥é˜… `docs/*_task_plan.md` äº†è§£å½“å‰çŠ¶æ€ã€‚æŠ€æœ¯æ¶æ„è¯¦è§ `docs/TECHNICAL_ARCHITECTURE_DESIGN.md`ã€‚

> ğŸ¯ **ç»™å¼€å‘è€…çš„æç¤º**: è¿™æ˜¯ä¸€ä¸ªéæŠ€æœ¯èƒŒæ™¯ç”¨æˆ·ä¸»å¯¼çš„é¡¹ç›®ï¼Œå¼ºè°ƒæ¦‚å¿µåˆ°ä»£ç çš„æ¸è¿›å¼è½¬åŒ–ã€‚æ–‡æ¡£æ˜¯ç†è§£é¡¹ç›®çš„å…³é”®ï¼Œç‰¹åˆ«æ˜¯ä¸‰æ–‡ä»¶æ¨¡å¼ä¸‹çš„å„ç±»æ–‡æ¡£ã€‚

---

## ğŸ“… æ›´æ–°æ—¥å¿—

### 2026-01-10 åç«¯è¿é€šæ€§ä¿®å¤

**é—®é¢˜æè¿°**: è®¾ç½®é¡µé¢é…ç½®ä¸ç”Ÿæ•ˆ - æ·»åŠ çš„APIæ¥å£ï¼ˆå¦‚OpenRouterï¼‰ä¸æ˜¾ç¤ºåœ¨ä¸‹æ‹‰æ¡†ä¸­ï¼Œé€‰æ‹©ä¼˜å…ˆæ¨¡å‹åä»ä½¿ç”¨æ—§é…ç½®ã€‚

**æ ¹æœ¬åŸå› **: é…ç½®æ ¼å¼ä¸åŒ¹é…
- `api_manager.py` æœŸæœ›æ‰å¹³æ ¼å¼: `claude_api_key`, `primary_api`
- `settings_tab_v2.py` ä¹‹å‰ä¿å­˜åµŒå¥—æ ¼å¼: `api.claude.api_key`, `global_settings.primary_api`

**ä¿®å¤å†…å®¹**:

#### 1. `cyber_mantic/ui/tabs/settings_tab_v2.py`
| æ–¹æ³• | ä¿®æ”¹ |
|------|------|
| `_save_api_config()` | æ”¹ä¸ºæ‰å¹³æ ¼å¼ä¿å­˜ (`{provider}_api_key`, `{provider}_model`) |
| `save_global_settings()` | å…¨å±€è®¾ç½®ä¿å­˜åˆ° `api` èŠ‚ç‚¹ (`primary_api`, `timeout`) |
| `_delete_api_config()` | åˆ é™¤æ‰å¹³æ ¼å¼çš„é…ç½®é”® |
| `_load_configured_apis()` | ä»æ‰å¹³æ ¼å¼è¯»å–å·²é…ç½®çš„APIåˆ—è¡¨ |
| `_load_global_settings()` | **æ–°å¢** - åˆå§‹åŒ–æ—¶ä»é…ç½®åŠ è½½å…¨å±€è®¾ç½®å€¼ |

#### 2. `cyber_mantic/api/manager.py`
| ä¿®æ”¹ | è¯´æ˜ |
|------|------|
| `__init__()` | åŠ¨æ€å‘ç°æ‰€æœ‰å·²é…ç½®providerï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰APIï¼‰ |
| `_get_default_model()` | **æ–°å¢** - è·å–å†…ç½®APIçš„é»˜è®¤æ¨¡å‹ |
| `_build_api_priority()` | **æ–°å¢** - æ„å»ºAPIä¼˜å…ˆçº§åˆ—è¡¨ |
| `_call_api_by_name()` | æ”¯æŒè°ƒç”¨è‡ªå®šä¹‰provider |
| `_call_openai_compatible()` | **æ–°å¢** - OpenAIå…¼å®¹æ ¼å¼è°ƒç”¨è‡ªå®šä¹‰API |

**é…ç½®æ ¼å¼è§„èŒƒ** (æ‰å¹³æ ¼å¼ï¼Œå­˜å‚¨åœ¨ `api` èŠ‚ç‚¹ä¸‹):
```yaml
api:
  # APIå¯†é’¥å’Œæ¨¡å‹
  claude_api_key: sk-xxx
  claude_model: claude-sonnet-4
  openrouter_api_key: sk-or-xxx
  openrouter_base_url: https://openrouter.ai/api/v1
  openrouter_model: anthropic/claude-3.5-sonnet
  # å…¨å±€è®¾ç½®
  primary_api: openrouter
  secondary_api: deepseek
  timeout: 60
  max_retries: 3
  enable_dual_verification: false
```

**ç”¨æˆ·æ“ä½œæµç¨‹**:
1. åœ¨ã€ŒAIæ¥å£ç®¡ç†ã€æ·»åŠ è‡ªå®šä¹‰APIï¼ˆå¡«å†™åç§°ã€Base URLã€API Keyã€æ¨¡å‹ï¼‰
2. åœ¨ã€Œå…¨å±€æ¨¡å‹è®¾ç½®ã€é€‰æ‹©ä¼˜å…ˆæ¨¡å‹
3. ç‚¹å‡»ã€Œä¿å­˜å…¨å±€è®¾ç½®ã€æŒ‰é’®
4. é‡å¯åº”ç”¨åé…ç½®ç”Ÿæ•ˆ

---

### 2026-01-10 é—®é“å¯¹è¯æµç¨‹ä¿®å¤

**é—®é¢˜æè¿°**:
1. å›æº¯éªŒè¯é—®é¢˜ç”Ÿæˆå¤±è´¥ - JSONè§£ææŠ¥é”™
2. å…«å­—/å¥‡é—¨ç­‰å¤šç†è®ºæœªå¯ç”¨ - åªç”¨äº†å°å…­å£¬å’Œæµ‹å­—
3. é˜¶æ®µè½¬æ¢æ··ä¹± - ç”¨æˆ·è¾“å…¥å‡ºç”Ÿä¿¡æ¯æ—¶ç›´æ¥è·³åˆ°æŠ¥å‘Š

**ä¿®å¤å†…å®¹**:

#### 1. `cyber_mantic/core/dynamic_verification.py`
| æ–¹æ³• | ä¿®æ”¹ |
|------|------|
| `_parse_ai_response()` | å¢å¼ºJSONè§£æï¼Œæ”¯æŒ \`\`\`json\`\`\` ä»£ç å—æ ¼å¼ |

#### 2. `cyber_mantic/services/conversation_service.py`
| æ–¹æ³• | ä¿®æ”¹ |
|------|------|
| `_handle_stage3_collect()` | æ·»åŠ  `_calculate_theory_fitness()` è°ƒç”¨ï¼Œé€‰æ‹©ç†è®ºåå†åˆ†æ |
| `_handle_stage4_verify()` | å¢åŠ ç”¨æˆ·æ„å›¾æ£€æµ‹ï¼ŒåŒºåˆ†éªŒè¯å›ç­”/ä¿®æ”¹ä¿¡æ¯/è·³è¿‡éªŒè¯ |

**æµç¨‹ä¿®æ­£**:
```
STAGE3_COLLECT:
  1. è§£æå‡ºç”Ÿä¿¡æ¯
  2. [æ–°å¢] é€‰æ‹©é€‚é…ç†è®º â†’ _calculate_theory_fitness()
  3. è¿è¡Œå¤šç†è®ºåˆ†æ â†’ _run_deep_analysis()
  4. ç”ŸæˆéªŒè¯é—®é¢˜

STAGE4_VERIFY:
  1. [æ–°å¢] æ£€æµ‹"è·³è¿‡/ç»§ç»­"å…³é”®è¯ â†’ ç›´æ¥ç”ŸæˆæŠ¥å‘Š
  2. [æ–°å¢] æ£€æµ‹å‡ºç”Ÿä¿¡æ¯ â†’ è¯¢é—®ç”¨æˆ·æ„å›¾
  3. è§£æéªŒè¯åé¦ˆ â†’ è°ƒæ•´ç½®ä¿¡åº¦
  4. ç”ŸæˆæŠ¥å‘Š
```

---

### 2026-01-10 å…¨å±€ä»£ç Review - è®¾è®¡ç›®æ ‡è½åœ°éªŒè¯

**ç›®çš„**: éªŒè¯è®¾è®¡ç›®æ ‡æ˜¯å¦åœ¨ä»£ç å±‚å®ç°ï¼Œç‰¹åˆ«æ˜¯ï¼š
- é—®é“æµç¨‹ä¸­æ˜¯å¦åªè°ƒç”¨äº†éƒ¨åˆ†ç†è®º
- FlowGuardæ˜¯å¦æ­£ç¡®å¤„ç†å¤šæ ·åŒ–ç”¨æˆ·æ“ä½œ
- é”™è¯¯å¤„ç†æ˜¯å¦å¯¼è‡´åŠŸèƒ½é™é»˜å¤±æ•ˆ

**å‘ç°çš„é—®é¢˜ä¸ä¿®å¤**:

#### 1. ç†è®ºé€‰æ‹©ä¸æ‰§è¡Œä¸åŒ¹é… (ä¸¥é‡)
**ä½ç½®**: `core/theory_selector.py`, `services/conversation_service.py`

**é—®é¢˜**:
- `theory_selector` å¯é€‰æ‹©8ä¸ªç†è®ºï¼ˆåŒ…æ‹¬å°å…­å£¬ã€æµ‹å­—æœ¯ï¼‰
- `THEORY_CONFIGS` åªæœ‰6ä¸ªç†è®º
- è‹¥é€‰ä¸­å°å…­å£¬/æµ‹å­—æœ¯ï¼Œä¼šåœ¨ `_run_deep_analysis` ä¸­è¢«é™é»˜è·³è¿‡

**ä¿®å¤**:
```python
# theory_selector.py - æ–°å¢æ’é™¤æœºåˆ¶
ALREADY_EXECUTED_THEORIES = {"å°å…­å£¬", "æµ‹å­—æœ¯"}

def select_theories(self, ..., exclude_theories=None):
    if exclude_theories is None:
        exclude_theories = self.ALREADY_EXECUTED_THEORIES
    # è·³è¿‡å·²æ’é™¤çš„ç†è®º
    for theory_name, theory in all_theories.items():
        if theory_name in exclude_theories:
            continue
```

#### 2. ç©ºç†è®ºåˆ—è¡¨æœªæ£€æŸ¥ (ä¸­ç­‰)
**ä½ç½®**: `services/conversation_service.py:_run_deep_analysis`

**é—®é¢˜**: è‹¥ `selected_theories` ä¸ºç©ºï¼Œåˆ†ææµç¨‹é™é»˜è·³è¿‡ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

**ä¿®å¤**:
```python
async def _run_deep_analysis(self, ...):
    # æ–°å¢æ£€æŸ¥
    if not self.context.selected_theories:
        self.logger.warning("selected_theories ä¸ºç©ºï¼Œæ— ç†è®ºå¯æ‰§è¡Œ")
        return

    # æ–°å¢æ‰§è¡Œç»Ÿè®¡
    executed_count = 0
    skipped_theories = []
    for theory_name in selected_theory_names:
        if theory_name in self.THEORY_CONFIGS:
            self._process_theory(...)
            executed_count += 1
        else:
            if theory_name not in ("å°å…­å£¬", "æµ‹å­—æœ¯"):
                skipped_theories.append(theory_name)

    self.logger.info(f"æ·±åº¦åˆ†æå®Œæˆ: {executed_count}/{len(selected_theory_names)} ä¸ªç†è®º")
```

#### 3. FlowGuardè®¾è®¡éªŒè¯ (æ­£å¸¸)
**éªŒè¯ç»“æœ**: FlowGuard è®¾è®¡åˆç†
- AIä¼˜å…ˆéªŒè¯ + ä»£ç åå¤‡éªŒè¯çš„åŒé‡æœºåˆ¶æ­£å¸¸å·¥ä½œ
- å„é˜¶æ®µè¾“å…¥è¦æ±‚å®šä¹‰å®Œæ•´
- ä¿®æ”¹æ„å›¾æ£€æµ‹åŠŸèƒ½æ­£å¸¸
- éªŒè¯é—®é¢˜ç”Ÿæˆå¤±è´¥æ—¶æœ‰é»˜è®¤é—®é¢˜å…œåº•

#### 4. é˜¶æ®µè½¬æ¢æœºåˆ¶ (æ­£å¸¸)
**éªŒè¯ç»“æœ**: é˜¶æ®µè½¬æ¢é€»è¾‘æ¸…æ™°
- STAGE1 â†’ STAGE2 â†’ STAGE3 â†’ STAGE4 â†’ STAGE5 â†’ QA
- å‘åå…¼å®¹æ—§é˜¶æ®µå
- `_sync_flow_guard_stage()` æ­£ç¡®åŒæ­¥FlowGuardçŠ¶æ€

**ä¿®æ”¹æ–‡ä»¶æ¸…å•**:
| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `core/theory_selector.py` | æ·»åŠ  `exclude_theories` å‚æ•°ï¼Œé»˜è®¤æ’é™¤å°å…­å£¬/æµ‹å­—æœ¯ |
| `services/conversation_service.py` | å¢å¼º `_run_deep_analysis` æ—¥å¿—å’Œç©ºå€¼æ£€æŸ¥ |

**æµ‹è¯•éªŒè¯**:
```
Selected theories (with default exclusion):
  - å¥‡é—¨éç”² (fitness: 0.91)
  - ç´«å¾®æ–—æ•° (fitness: 0.91)
  - æ¢…èŠ±æ˜“æ•° (fitness: 0.54)
  - å…«å­— (fitness: 0.89)
  - å¤§å…­å£¬ (fitness: 0.78)

Contains xiaoliu: False
Contains cezi: False
Test PASSED: True
```

