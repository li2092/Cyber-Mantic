# 总体设计概述

> **版本**：v4.0
> **更新日期**：2026-01-05

---

## 1. 标签页架构

### 1.1 标签页定义

| 序号 | 名称 | 原名称 | 功能定位 |
|------|------|--------|---------|
| 1 | **问道** | AI对话 | 对话式渐进预测，主打交互体验 |
| 2 | **推演** | 分析 | 快速排盘分析，沿用现有功能 |
| 3 | **典籍** | 新增 | 术数资料阅读与学习 |
| 4 | **洞察** | 新增 | 用户画像与状态评估 |
| 5 | **历史记录** | 历史记录 | 问道+推演历史统一管理 |
| 6 | **设置** | 设置 | 配置管理，内含帮助子模块 |

### 1.2 布局示意

```
┌────────┬────────┬────────┬────────┬──────────┬────────┐
│  问道  │  推演  │  典籍  │  洞察  │ 历史记录 │  设置  │
└────────┴────────┴────────┴────────┴──────────┴────────┘
```

### 1.3 设计理由

- **问道置首**：主打对话式交互，降低用户使用门槛，增强体验温度
- **推演保留**：满足熟练用户快速分析需求
- **典籍新增**：构建学习闭环，用户可深入了解术数理论
- **洞察新增**：用户画像分析 + 安全预警机制
- **设置整合**：帮助功能融入设置，减少标签数量

---

## 2. 核心交互流程

### 2.1 首次启动流程

```
应用启动
    │
    ▼
┌─────────────────────────────┐
│ 首次启动界面                 │
│ • 语言选择（6种）           │
│ • 完整免责声明              │
│ • 南半球适用性提示          │
│ • 三项勾选确认              │
└──────────────┬──────────────┘
               │
               ▼
┌─────────────────────────────┐
│ 首次引导流程（可跳过）       │
│ 问道→推演→典籍→洞察→设置    │
│ 共5步                       │
└──────────────┬──────────────┘
               │
               ▼
           正常使用
```

### 2.2 日常使用流程

```
┌─────────────────────────────────────────────────────────┐
│                      应用主界面                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  [问道]                                                 │
│    │                                                    │
│    ├─ 输入问题                                          │
│    ├─ 输入出生信息                                      │
│    │     └─ 点发送 → 年龄检测                           │
│    │           ├─ ≥18岁 → 简版提示(会话首次) → 执行     │
│    │           └─ <18岁 → 未成年人提示 → 确认后执行     │
│    └─ AI对话交互                                        │
│                                                         │
│  [推演]                                                 │
│    │                                                    │
│    ├─ 填写信息                                          │
│    └─ 点分析 → 年龄检测 → 提示确认 → 执行分析           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 数据架构

### 3.1 本地存储结构

```
~/.xuanshu/
├── config.yaml              # 用户配置
├── history.db               # 历史记录数据库
├── profile.db               # 用户画像数据库
├── notes.db                 # 笔记数据库
├── lock_status.json         # 锁定状态（独立文件）
├── documents/               # 用户导入的资料
│   └── ...
└── cache/                   # 缓存目录
    └── ...
```

### 3.2 安装目录结构

```
xuanshu/
├── resources/
│   └── library/             # 系统预置资料
│       ├── 00_入门指南/
│       ├── 01_八字/
│       └── ...
├── i18n/                    # 多语言文件
├── docs/prompts/            # Prompt模板
└── ...
```

---

## 4. 技术栈更新

| 层级 | 现有 | 新增/变更 |
|------|------|----------|
| GUI框架 | PyQt6 | 无变化 |
| 文档解析 | - | python-docx, PyMuPDF, markdown |
| 加密存储 | - | cryptography (API Key加密) |
| AI客户端 | 各SDK独立 | 统一封装 UnifiedAIClient |
| 国际化 | - | JSON + Qt Linguist |
