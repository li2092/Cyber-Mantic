# 洞察模块设计

> **版本**：v4.0
> **更新日期**：2026-01-05

---

## 1. 功能概述

洞察模块提供用户画像分析、使用统计、状态评估与预警保护功能。

**核心理念**：预警是关怀而非惩罚，保护用户心理健康。

---

## 2. 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│ [洞察]                                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────── 使用画像 ───────────────┐                 │
│  │ 📊 使用频率：周活跃用户                  │                 │
│  │ ⏰ 常用时段：晚间 20:00-23:00           │                 │
│  │ 🎯 偏好理论：八字(60%) 紫微(25%) 其他    │                 │
│  │ 💬 问题类型：事业(45%) 感情(35%) 健康    │                 │
│  └─────────────────────────────────────────┘                │
│                                                             │
│  ┌─────────────── AI深度分析 ──────────────┐                │
│  │ 🧠 基于您近30天的使用数据，分析如下：    │                │
│  │                                         │                │
│  │ • 您近期关注重心从事业转向感情...        │                │
│  │ • 建议适当拓展其他术数理论视角...        │                │
│  │ • 您的使用模式显示决策风格偏谨慎...      │                │
│  │                                         │                │
│  │ [刷新分析]              更新于 2h前     │                │
│  └─────────────────────────────────────────┘                │
│                                                             │
│  ┌─────────────── 状态评估 ───────────────┐                 │
│  │ 当前状态：😊 正常                        │                 │
│  │ [查看详情]                              │                 │
│  └─────────────────────────────────────────┘                │
│                                                             │
│  ┌─────────────── 使用统计 ───────────────┐                 │
│  │ 本周问道：12次 │ 本周推演：5次           │                 │
│  │ 历史总计：问道 156次 │ 推演 89次         │                 │
│  └─────────────────────────────────────────┘                │
│                                                             │
│  [查看/删除我的数据]                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 预警机制

### 3.1 异常模式定义

```python
ABNORMAL_PATTERNS = {
    # 频率类 - 适当放宽，加入时间分布判断
    "密集分析": "6小时内分析>5次（同一问题类型）",

    # 时段类 - 关注持续性而非单次
    "深夜沉迷": "凌晨1-5点连续使用>1.5小时，且近7天出现>3次",

    # 情绪类 - 最重要，本地检测
    "情绪化关键词": {
        "高危": ["不想活", "活着没意思", "结束一切", "自杀", "自残"],
        "中危": ["绝望", "崩溃", "受不了了", "没有出路"],
        "低危": ["焦虑", "失眠", "压力大"]
    },

    # 依赖类 - 关注模式而非绝对数量
    "重复验证": "同一八字24小时内分析>3次，且每次问相同问题",
    "否认现实": "对分析结果连续3次表示'不准/不信'后仍继续分析"
}
```

### 3.2 分级响应

| 级别 | 触发条件 | 响应方式 |
|------|---------|---------|
| **关怀提示** | 低危情绪词 / 深夜使用 | 温和提示，不阻止使用 |
| **暂停建议** | 中危情绪词 / 重复验证 | 弹窗选择：继续 / 休息60分钟 |
| **强制冷却** | 高危情绪词 | 锁定24h + 危机指引 + AI关怀话语 |

### 3.3 响应界面

#### 关怀提示
```
💙 您今天使用时间较长，记得休息哦
```

#### 暂停建议
```
┌─────────────────────────────────────────────────────┐
│                                                     │
│   💙 您似乎比较焦虑                                 │
│                                                     │
│   要不要喝杯茶休息一下？                            │
│                                                     │
│         [继续使用]    [休息60分钟]                  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### 强制冷却
```
┌─────────────────────────────────────────────────────┐
│                                                     │
│   💙 我们注意到您可能正在经历一些困难                 │
│                                                     │
│   [AI生成的温暖关怀文字...]                          │
│                                                     │
│   如果您需要专业支持：                               │
│   📞 全国心理援助热线：400-161-9995                  │
│   📞 北京心理危机研究与干预中心：010-82951332        │
│   📞 生命热线：400-821-1215                         │
│   📞 青少年心理热线：12355                          │
│                                                     │
│   系统将在 23:45:32 后恢复使用                       │
│                                                     │
│   [我只是随便说说，申请解除]                         │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 3.4 "随便说说"免责流程

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│   💙 我们需要确认您目前的状态                        │
│                                                     │
│   1. 您现在是否有伤害自己的想法？                    │
│      ○ 没有，我只是情绪发泄                         │
│      ○ 有一点，但不会付诸行动                       │
│      ○ 我需要帮助 → [跳转专业资源]                  │
│                                                     │
│   2. 您是否愿意尝试以下方式缓解情绪？                │
│      □ 深呼吸3分钟                                  │
│      □ 和朋友/家人聊聊                              │
│      □ 出门散步                                     │
│      □ 我已经好多了                                 │
│                                                     │
│   3. 请输入"我确认当前状态良好"以解除限制            │
│      [________________]                             │
│                                                     │
│   ⚠️ 此记录将被保存用于产品改进（不含个人信息）       │
│                                                     │
│                              [提交并解除限制]        │
└─────────────────────────────────────────────────────┘
```

---

## 4. DeepSeek-Reasoner 画像分析

### 4.1 触发条件

- 每次启动应用时调用
- 问道 + 推演总次数 ≥ 5 时启用
- 次数不足时显示"暂无足够数据进行分析"

### 4.2 分析维度

- 使用频率趋势
- 关注话题变化
- 决策风格特征
- 个性化建议

---

## 5. 数据管理

### 5.1 存储结构

```sql
-- 用户画像数据库 ~/.xuanshu/profile.db

CREATE TABLE usage_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    date DATE NOT NULL,
    module TEXT NOT NULL,           -- 'wendao' | 'tuiyan'
    theory TEXT,                    -- 使用的术数理论
    question_type TEXT,             -- 问题类型
    duration_seconds INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE behavior_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_type TEXT NOT NULL,
    event_data TEXT,                -- JSON
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE risk_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    risk_level TEXT NOT NULL,       -- 'low' | 'medium' | 'high'
    trigger_pattern TEXT,
    user_response TEXT,             -- 用户选择的响应
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 5.2 锁定状态文件

```json
// ~/.xuanshu/lock_status.json
{
    "is_locked": true,
    "lock_until": "2026-01-06T14:32:00",
    "lock_reason": "high_risk_keyword",
    "created_at": "2026-01-05T14:32:00"
}
```

### 5.3 隐私政策

| 项目 | 说明 |
|------|------|
| 数据位置 | 全部本地存储 |
| 敏感检测 | 高危关键词本地检测，不上传 |
| 用户权限 | 可查看、可删除画像数据 |
| 锁定例外 | 用户不能自行解除锁定倒计时 |
| 保留期限 | 默认永久，用户可手动删除 |

---

## 6. 设计原则

1. **不是惩罚，是关怀** —— 措辞温暖，避免"您已被禁止"等表述
2. **隐私优先** —— 高危词本地检测，不上传服务器
3. **留有出口** —— "我只是随便说说"申请通道
4. **数据透明** —— 用户可查看/删除画像，但不能跳过冷却期
