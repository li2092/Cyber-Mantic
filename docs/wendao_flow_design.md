# 问道核心流程设计文档

## 1. 流程概述

问道采用**5阶段8步骤**渐进式对话模式，除欢迎消息外所有系统回复由AI动态生成。

```
┌─────────────────────────────────────────────────────────────────┐
│  阶段0: 欢迎                                                     │
│  系统 → 用户: 欢迎消息 + 引导提示                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  阶段1: 破冰                                                     │
│  用户 → 系统: 咨询大类 + 3个数字                                 │
│  系统 → 用户: 小六壬初判 + 追问(具体事情+汉字)                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  阶段2: 深入                                                     │
│  用户 → 系统: 具体描述 + 汉字                                    │
│  系统 → 用户: 小六壬+测字综合分析 + 追问(详细信息)               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  阶段3: 信息收集                                                 │
│  用户 → 系统: 生辰+性别+MBTI+颜色/方位                           │
│  系统 → 用户: 多理论分析 + 回溯验证问题                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  阶段4: 验证                                                     │
│  用户 → 系统: 回答验证问题                                       │
│  系统 → 用户: 综合分析报告                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  阶段5: 问答                                                     │
│  用户可以追问、保存对话                                          │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 各阶段详细设计

### 2.1 阶段0: 欢迎

| 项目 | 说明 |
|------|------|
| 触发 | 用户进入问道页面 |
| 系统行为 | 发送固定欢迎模板 |
| 输出 | 欢迎消息 + 操作引导 |

**欢迎消息模板**:
```markdown
👋 欢迎使用赛博玄数 - 问道模式

请告诉我：
1. 您想咨询的事项类别（事业/感情/财运/健康/学业/决策/其他）
2. 心里想着这件事，随机说3个1-9的数字

示例："事业，3 5 7"
```

---

### 2.2 阶段1: 破冰

| 项目 | 说明 |
|------|------|
| 用户输入 | 咨询大类 + 3个数字 |
| 系统处理 | 记录起卦时间 → 小六壬计算 → AI生成回复 |
| 系统输出 | 小六壬初判 + 追问 |

**数据收集**:
```python
context.question_category = "事业"     # AI解析
context.random_numbers = [3, 5, 7]     # AI解析
context.qigua_time = datetime.now()    # 记录起卦时间
context.xiaoliu_result = {...}         # 小六壬计算结果
```

**AI生成任务**:
- 输入: 小六壬结果、咨询类别
- 输出: 初判描述(50-80字) + 追问语句

**追问内容**:
1. 请简单描述一下具体是什么事情
2. 想着这件事，脑海中浮现的第一个汉字是什么？

---

### 2.3 阶段2: 深入

| 项目 | 说明 |
|------|------|
| 用户输入 | 具体事情描述 + 汉字 |
| 系统处理 | 测字术计算 → AI综合分析 → 生成回复 |
| 系统输出 | 小六壬+测字综合分析 + 追问 |

**数据收集**:
```python
context.question_description = "想跳槽到互联网公司"  # AI解析
context.character = "变"                            # AI解析
context.cezi_result = {...}                         # 测字术计算结果
```

**AI生成任务**:
- 输入: 小六壬结果、测字术结果、事情描述
- 输出: 综合分析(100-150字) + 追问语句

**追问内容**:
1. 您的出生日期（可以说不记得具体时辰）
2. 性别
3. MBTI类型（可选，不知道可跳过）
4. 现在面朝的方向 或 今天穿的衣服主色调（二选一，可选）

---

### 2.4 阶段3: 信息收集

| 项目 | 说明 |
|------|------|
| 用户输入 | 生辰八字 + 性别 + MBTI + 颜色/方位 |
| 系统处理 | AI解析 → 多理论计算 → 生成回溯问题 |
| 系统输出 | 多理论分析 + 回溯验证问题 |

**数据收集**:
```python
context.birth_info = {
    "year": 1990, "month": 5, "day": 15,
    "hour": None,  # 可能为空
    "time_certainty": "unknown"  # certain/uncertain/unknown
}
context.gender = "male"
context.mbti_type = "INTJ"  # 可能为空
context.favorite_color = "红色"  # 或
context.current_direction = "东"  # 二选一
```

**理论计算触发**:
| 理论 | 触发条件 | 输入 |
|------|----------|------|
| 八字 | 有生辰 | birth_info |
| 紫微 | 有完整生辰(含时辰) | birth_info |
| 梅花 | 有颜色或方位 | favorite_color / current_direction |
| 六爻 | 自动 | qigua_time生成的数字 |
| 奇门 | 有方位 | current_direction |

**六爻自动起卦**:
```python
def generate_liuyao_numbers(qigua_time: datetime) -> List[int]:
    """用起卦时间生成六爻数字"""
    ts = qigua_time.timestamp()
    秒 = int(ts) % 60
    微秒 = int((ts % 1) * 1000000)

    num1 = (秒 % 9) + 1
    num2 = ((秒 + 微秒 // 1000) % 9) + 1
    num3 = ((秒 + 微秒 // 100) % 9) + 1

    return [num1, num2, num3]
```

**AI生成任务**:
- 输入: 所有理论计算结果
- 输出: 多理论综合分析 + 3个回溯验证问题

---

### 2.5 阶段4: 验证

| 项目 | 说明 |
|------|------|
| 用户输入 | 回答验证问题 |
| 系统处理 | 解析反馈 → 调整置信度 → 生成最终报告 |
| 系统输出 | 综合分析报告 |

**置信度调整**:
| 反馈类型 | 调整 |
|----------|------|
| 符合 | +0.2 |
| 部分符合 | +0.1 |
| 不符合 | -0.15 |

---

### 2.6 阶段5: 问答

用户可以：
- 追问具体解读
- 询问行动建议
- 保存对话记录

---

## 3. 数据模型

### 3.1 ConversationContext 新增/修改字段

```python
class ConversationContext:
    # 阶段1
    qigua_time: Optional[datetime] = None  # 新增：起卦时间

    # 阶段2
    character: Optional[str] = None  # 新增：测字用的汉字
    cezi_result: Optional[Dict] = None  # 新增：测字结果

    # 阶段3（部分已存在）
    favorite_color: Optional[str] = None
    current_direction: Optional[str] = None
    liuyao_numbers: List[int] = []  # 新增：六爻数字(自动生成)
```

### 3.2 ConversationStage 枚举重定义

```python
class ConversationStage(Enum):
    INIT = "初始化"
    STAGE1_ICEBREAK = "阶段1_破冰"      # 小六壬
    STAGE2_DEEPEN = "阶段2_深入"        # 新增：测字
    STAGE3_COLLECT = "阶段3_信息收集"   # 多理论
    STAGE4_VERIFY = "阶段4_验证"        # 回溯
    STAGE5_REPORT = "阶段5_报告"        # 综合报告
    QA = "问答交互"
    COMPLETED = "完成"
```

---

## 4. AI提示词模板

### 4.1 阶段1回复模板

```markdown
# 角色
你是赛博玄数的占卜师，精通小六壬。

# 任务
根据小六壬结果给出初步判断，并自然地追问更多信息。

# 输入
- 咨询类别：{{category}}
- 小六壬结果：{{xiaoliu_result}}

# 输出要求
1. 先用50-80字描述小六壬的初步判断
2. 自然过渡到追问：
   - 请简单描述一下具体是什么事情
   - 想着这件事时，脑海中浮现的第一个汉字是什么？
3. 语气温和、专业，不要过于神秘
```

### 4.2 阶段2回复模板

```markdown
# 角色
你是赛博玄数的占卜师，精通小六壬和测字术。

# 任务
综合小六壬和测字术给出分析，并追问详细信息。

# 输入
- 咨询类别：{{category}}
- 具体事情：{{description}}
- 小六壬结果：{{xiaoliu_result}}
- 测字结果：{{cezi_result}}

# 输出要求
1. 综合分析（100-150字），融合两种理论的判断
2. 自然过渡到追问详细信息：
   - 出生日期（提示可以说不记得时辰）
   - 性别
   - MBTI（说明可选）
   - 方位或颜色（说明二选一，可选）
3. 语气温和、专业
```

### 4.3 阶段3回复模板

```markdown
# 角色
你是赛博玄数的占卜师，精通多种术数理论。

# 任务
综合多理论给出详细分析，并生成回溯验证问题。

# 输入
- 咨询类别：{{category}}
- 具体事情：{{description}}
- 已计算理论：{{theory_results}}

# 输出要求
1. 多理论综合分析（200-300字）
2. 生成3个回溯验证问题：
   - 关于过去3-5年的关键事件
   - 与咨询事项相关
   - 简单的是/否问题
```

---

## 5. 边界情况处理

### 5.1 用户输入不完整

| 情况 | 处理方式 |
|------|----------|
| 只说大类没给数字 | 提示补充数字 |
| 不想说汉字 | 使用时辰地支第一个字 |
| 不想给可选信息 | 跳过对应理论，使用已有信息分析 |
| 不记得时辰 | 使用三柱八字 |

### 5.2 可选信息缺失时的理论选择

| 缺失信息 | 影响 | 降级方案 |
|----------|------|----------|
| MBTI | 跳过MBTI分析 | 不影响其他理论 |
| 颜色/方位都缺 | 梅花无法用颜色/方位起卦 | 使用时间起卦 |
| 时辰 | 紫微无法计算 | 只用八字三柱 |

---

## 6. UI交互说明

### 6.1 右侧面板显示

| 阶段 | 显示内容 |
|------|----------|
| 1 | 小六壬快断卡片 |
| 2 | 小六壬 + 测字卡片 |
| 3 | 多理论快速结论卡片 |
| 4 | 回溯验证面板 |
| 5 | 综合置信度显示 |

### 6.2 进度显示

使用FlowGuard显示信息收集进度：
- 必填信息完成度
- 可选信息完成度
- 当前阶段

---

## 7. 后续优化方向

1. **智能理论推荐**: 根据咨询类型自动推荐最适合的理论组合
2. **多轮验证**: 允许用户对初步结果进行多次反馈
3. **报告导出**: 支持导出PDF/图片格式的完整报告
4. **历史对比**: 对比多次咨询的结果变化

---

## 8. 审核清单

请大魔王确认以下内容：

- [ ] 流程步骤是否符合预期？
- [ ] 阶段划分是否合理？
- [ ] 六爻自动起卦方案是否可行？
- [ ] 颜色/方位二选一的交互方式？
- [ ] 可选信息缺失时的降级方案？
- [ ] AI提示词设计方向？
