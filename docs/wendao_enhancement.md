# 问道界面完善方案 - 交付物

> 版本：v1.0
> 更新时间：2026-01-08

---

## 一、功能概述

"问道"是赛博玄数的核心功能模块，采用渐进式5阶段智能交互流程，通过自然对话收集用户信息，智能选择术数理论进行分析，最终生成个性化报告。

---

## 二、交互流程

```
┌─────────────────────────────────────────────────────────┐
│                     问道界面布局                          │
├───────────────────────────────┬─────────────────────────┤
│                               │                         │
│    💬 对话区域 (65%)          │   📊 关键信息 (35%)     │
│                               │                         │
│  ┌─────────────────────────┐  │  ┌───────────────────┐  │
│  │ 欢迎消息 (打字机效果)    │  │  │ 小六壬快断        │  │
│  └─────────────────────────┘  │  └───────────────────┘  │
│                               │                         │
│  ┌─────────────────────────┐  │  ┌───────────────────┐  │
│  │ 用户消息 (右对齐)       │  │  │ 理论按钮 (2x3)    │  │
│  └─────────────────────────┘  │  │ [八字][紫微][奇门] │  │
│                               │  │ [六壬][六爻][梅花] │  │
│  ┌─────────────────────────┐  │  └───────────────────┘  │
│  │ AI回复 (打字机效果)     │  │                         │
│  └─────────────────────────┘  │  ┌───────────────────┐  │
│                               │  │ 八字命盘          │  │
│  ...更多对话...               │  └───────────────────┘  │
│                               │                         │
│  ┌─────────────────────────┐  │  ┌───────────────────┐  │
│  │ 输入框              [发送]│  │ │ 分析状态/进度     │  │
│  └─────────────────────────┘  │  └───────────────────┘  │
│                               │                         │
└───────────────────────────────┴─────────────────────────┘
```

---

## 三、5阶段详细设计

### 阶段1：破冰

**目标**：快速了解用户需求，提供初步判断

**输入要求**：
- 咨询事项（事业/感情/财运/健康/学业/决策/其他）
- 问题描述（简述具体问题）
- 随机数字（3个1-9的数字，用于小六壬）

**输出**：
- 小六壬快速判断（落宫、吉凶、初步建议）
- 引导用户进入下一阶段

**技术实现**：
```python
# NLP解析用户输入
parsed_info = await nlp_parser.parse_icebreak_input(user_message)
# 小六壬计算
xiaoliu_result = xiaoliu_theory.calculate(user_input)
# AI解读结果
interpretation = await _interpret_xiaoliu(xiaoliu_result)
```

---

### 阶段2：基础信息收集

**目标**：收集出生信息，计算理论适配度

**输入要求**：
- 出生年月日（必需）
- 出生时辰（可确定/不确定/未知）
- 性别（可选）
- MBTI类型（可选）

**输出**：
- 时辰确定性评估
- 可用术数理论列表（带适配度评分）
- 根据时辰确定性决定是否需要补充

**技术实现**：
```python
# NLP解析出生信息
birth_info = await nlp_parser.parse_birth_info(user_message)
# 理论选择
selected_theories = theory_selector.select_theories(user_input)
```

**时辰分类**：
| 状态 | 说明 | 后续流程 |
|------|------|----------|
| certain | 用户明确知道出生时辰 | 跳过阶段3，直接进入阶段4 |
| uncertain | 用户不太确定 | 进入阶段3补充推断 |
| unknown | 用户完全不知道 | 进入阶段3补充推断 |

---

### 阶段3：深度补充

**目标**：通过旁证推断时辰

**推断依据**：
1. **兄弟姐妹排行**
   - 老大/独生 → 某些时辰概率高
   - 排行中间 → 另一些时辰概率高

2. **脸型特征**
   - 圆脸 → 与某些地支关联
   - 方脸/瓜子脸 → 与其他地支关联

3. **作息习惯**
   - 入睡时间可辅助判断

**输出**：
- 推断的时辰
- 更新birth_info中的hour字段

---

### 阶段4：结果验证

**目标**：通过回溯验证提高准确度

**验证方式**：
- 询问过去3-5年的重大事件
- 与理论推算对比
- 调整各理论置信度

**技术实现**：
```python
# 解析验证反馈
feedback = await nlp_parser.parse_verification_feedback(user_message, events)
# 调整置信度
_adjust_confidence(feedback)
# 执行深度分析
await _run_deep_analysis()
```

---

### 阶段5：完整报告

**目标**：生成综合分析报告

**报告结构**：
1. **概述**：问题回顾、使用理论
2. **核心分析**：各理论独立结论
3. **综合判断**：融合多理论观点
4. **行动建议**：具体可执行建议
5. **注意事项**：局限性说明

**后续**：进入QA阶段，持续答疑

---

## 四、UI组件规格

### 4.1 ChatWidget

| 属性 | 规格 |
|------|------|
| 消息气泡 | 圆角8px，内边距12px |
| 用户消息 | 右对齐，浅色背景 |
| AI消息 | 左对齐，支持Markdown |
| 打字机效果 | 15ms/组，换行150ms |
| 字体大小 | 默认11pt，可调9-18pt |

### 4.2 右侧面板

| 组件 | 规格 |
|------|------|
| 面板宽度 | 最小280px，最大380px |
| 小六壬卡片 | 最大高度120px |
| 理论按钮 | 2x3网格，高度40px |
| 八字命盘 | 表格展示，最大高度200px |
| 进度条 | 固定底部，有情绪化文字 |

### 4.3 进度反馈

| 阶段 | 进度 | 情绪化描述 |
|------|------|------------|
| 破冰 | 10-20% | "正在感应您的问题..." |
| 信息收集 | 20-40% | "正在排列星象..." |
| 深度补充 | 40-60% | "正在推演时辰..." |
| 验证 | 60-80% | "正在回溯验证..." |
| 报告生成 | 80-100% | "正在撰写报告..." |

---

## 五、API调用策略

### 优先级顺序

1. **用户设置**：Settings中配置的primary_api
2. **任务推荐**：根据任务类型匹配最佳API
3. **可用兜底**：第一个可用的API

### 任务-API映射

| 任务类型 | 推荐API | 原因 |
|----------|---------|------|
| 深度分析 | Claude | 推理能力强 |
| 快速交互 | Deepseek | 响应快、成本低 |
| NLP解析 | Kimi | 中文理解好 |
| 综合报告 | Gemini | 长文本能力 |

### 故障转移

```python
# 自动切换到下一个可用API
for api in available_apis:
    try:
        response = await call_api(api, prompt)
        return response
    except Exception:
        continue
```

---

## 六、异常处理

### 用户输入异常

| 情况 | 处理 |
|------|------|
| 空消息 | 忽略，不发送 |
| 格式错误 | 友好提示，给出示例 |
| 信息不完整 | 追问缺失信息 |

### 系统异常

| 情况 | 处理 |
|------|------|
| API超时 | 自动切换备用API |
| 计算失败 | 记录日志，返回友好提示 |
| 线程异常 | 安全取消，清理资源 |

---

## 七、数据安全

### 本地存储

- 对话记录存储在用户本地
- 可选择加密存储
- 一键清空功能

### API调用

- 仅发送必要信息
- 不存储用户真实姓名
- 出生信息用于计算后即释放

---

## 八、后续规划

### 短期 (v1.1)

- [ ] 回车键发送支持
- [ ] 对话保存/加载验证
- [ ] 错误提示优化

### 中期 (v1.2)

- [ ] 八字命盘可视化
- [ ] 理论详情弹窗
- [ ] 报告导出PDF

### 长期 (v2.0)

- [ ] 语音输入支持
- [ ] 多会话管理
- [ ] 报告分享功能

---

## 附录：测试清单

### 功能测试

- [ ] 5阶段完整流程
- [ ] 各API切换正常
- [ ] 打字机效果流畅
- [ ] 用户消息右对齐
- [ ] 进度条更新正确

### 边界测试

- [ ] 快速连续发送
- [ ] 长消息显示
- [ ] 特殊字符处理
- [ ] 网络中断恢复

### 性能测试

- [ ] 长对话内存占用
- [ ] 响应时间 < 30s
- [ ] 动画流畅度 > 30fps
