# 赛博玄数 - 功能与数据流映射文档

> 本文档详细描述了后端功能模块与前端界面的对应关系，以及各功能的数据流向，供UI重构参考。

---

## 一、系统架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 UI 层                                │
│  ┌──────┬──────┬──────┬──────┬──────┬──────┐                   │
│  │ 问道 │ 推演 │ 典籍 │ 洞察 │ 历史 │ 设置 │                   │
│  └──┬───┴──┬───┴──┬───┴──┬───┴──┬───┴──┬───┘                   │
└─────┼──────┼──────┼──────┼──────┼──────┼────────────────────────┘
      │      │      │      │      │      │
┌─────┴──────┴──────┴──────┴──────┴──────┴────────────────────────┐
│                       服务层 (Services)                          │
│  ┌─────────────────┬─────────────────┬─────────────────┐        │
│  │ConversationSvc  │ AnalysisService │ ReportService   │        │
│  └────────┬────────┴────────┬────────┴────────┬────────┘        │
└───────────┼─────────────────┼─────────────────┼─────────────────┘
            │                 │                 │
┌───────────┴─────────────────┴─────────────────┴─────────────────┐
│                    核心引擎层 (Core Engine)                      │
│  ┌────────────────┬────────────────┬────────────────┐           │
│  │DecisionEngine  │TheorySelector  │ConflictResolver│           │
│  └────────┬───────┴────────┬───────┴────────┬───────┘           │
└───────────┼────────────────┼────────────────┼───────────────────┘
            │                │                │
┌───────────┴────────────────┴────────────────┴───────────────────┐
│                    计算引擎层 (Theories)                         │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┐                      │
│  │八字│紫微│奇门│六壬│六爻│梅花│小六│测字│                      │
│  └────┴────┴────┴────┴────┴────┴────┴────┘                      │
└─────────────────────────────────────────────────────────────────┘
            │
┌───────────┴─────────────────────────────────────────────────────┐
│                      AI API 层                                   │
│  ┌──────────┬──────────┬──────────┬──────────┐                  │
│  │ Claude   │ Gemini   │ DeepSeek │   Kimi   │                  │
│  └──────────┴──────────┴──────────┴──────────┘                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、问道标签页 (AIConversationTab)

### 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                         问道标签页                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    用户输入消息                                │
│  │  输入框     │ ─────────────────┐                             │
│  │ input_text  │                  │                             │
│  └─────────────┘                  ▼                             │
│                          ┌─────────────────┐                    │
│  ┌─────────────┐         │ConversationWorker                    │
│  │  发送按钮   │ ───────▶│   (QThread)     │                    │
│  │  send_btn   │         └────────┬────────┘                    │
│  └─────────────┘                  │                             │
│                                   ▼                             │
│                    ┌──────────────────────────┐                 │
│                    │  ConversationService     │                 │
│                    │  5阶段对话流程管理        │                 │
│                    └────────────┬─────────────┘                 │
│                                 │                               │
│          ┌──────────────────────┼──────────────────────┐        │
│          │                      │                      │        │
│          ▼                      ▼                      ▼        │
│  ┌───────────────┐   ┌──────────────────┐   ┌──────────────┐   │
│  │  NLPParser    │   │  QAHandler       │   │WarningManager│   │
│  │  自然语言解析  │   │  问答处理        │   │ 情绪预警检测  │   │
│  └───────┬───────┘   └────────┬─────────┘   └──────┬───────┘   │
│          │                    │                     │           │
│          ▼                    ▼                     ▼           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                      APIManager                           │ │
│  │              调用AI模型生成回复                            │ │
│  └───────────────────────────┬───────────────────────────────┘ │
│                              │                                  │
│          ┌───────────────────┼───────────────────┐              │
│          │                   │                   │              │
│          ▼                   ▼                   ▼              │
│  ┌─────────────┐    ┌─────────────┐     ┌─────────────────┐    │
│  │ ChatWidget  │    │ bazi_text   │     │ ProgressWidget  │    │
│  │ 消息气泡显示 │    │ 八字命盘    │     │ 进度显示        │    │
│  └─────────────┘    └─────────────┘     └─────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5阶段对话流程

| 阶段 | 输入 | 后端处理 | 输出 | 前端展示 |
|------|------|----------|------|----------|
| **破冰** | 事项分类 + 3个随机数 | XiaoLiuRenTheory.calculate() | 小六壬快速初判 | 六神结果卡片 |
| **基础信息** | 年月日/性别/MBTI | NLPParser.parse_birth_info() | 可用理论列表 | 理论选择提示 |
| **深度补充** | 时辰推断/额外占卜 | TheorySelector.get_completeness() | 完备度更新 | 八字命盘更新 |
| **结果确认** | 过去3-5年事件 | BaZiCalculator.verify_events() | 验证分析准确性 | 确认提示 |
| **完整报告** | 确认信息 | DecisionEngine.analyze() | 综合报告 | 报告卡片 |

### 后端功能对应

| 后端功能 | 文件位置 | 前端组件 | 实现状态 |
|----------|----------|----------|----------|
| 对话上下文管理 | `conversation/context.py` | ChatWidget | ✅ 已实现 |
| 自然语言解析 | `conversation/nlp_parser.py` | input_text处理 | ✅ 已实现 |
| 问答处理 | `conversation/qa_handler.py` | ChatWidget | ✅ 已实现 |
| 报告生成 | `conversation/report_generator.py` | 无明确展示区 | ⚠️ 部分实现 |
| 阶段处理器 | `conversation/stage_handlers.py` | stage_label | ✅ 已实现 |
| 小六壬计算 | `theories/xiaoliu/` | 无专门展示 | ❌ 未在UI呈现 |
| 测字术 | `theories/cezi/` | 无输入框 | ❌ 未在UI呈现 |
| 梅花易数 | `theories/meihua/` | 无专门展示 | ❌ 未在UI呈现 |
| MBTI分析 | `utils/mbti_analyzer.py` | 无MBTI选择 | ❌ 未在UI呈现 |
| 情绪预警 | `utils/warning_manager.py` | WarningDialogs | ✅ 已实现 |

### 缺失的前端功能

1. **小六壬结果卡片** - 后端已计算，前端无专门展示区
2. **MBTI选择器** - 后端支持个性化，前端无输入
3. **多理论结果对比视图** - 后端支持多理论，前端仅展示八字
4. **测字输入** - 问道中无测字功能入口
5. **对话导出按钮** - 仅支持保存，不支持导出

---

## 三、推演标签页 (AnalysisTab)

### 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                         推演标签页                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                     InputPanel                           │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────────────┐ │  │
│  │  │问题类别    │  │问题描述    │  │出生日期时辰性别    │ │  │
│  │  │QComboBox   │  │QLineEdit   │  │QSpinBox/QComboBox  │ │  │
│  │  └────────────┘  └────────────┘  └────────────────────┘ │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────────────┐ │  │
│  │  │测字输入    │  │随机数字    │  │多人八字管理        │ │  │
│  │  │QLineEdit   │  │QSpinBox x3 │  │List + 按钮         │ │  │
│  │  └────────────┘  └────────────┘  └────────────────────┘ │  │
│  └───────────────────────────┬──────────────────────────────┘  │
│                              │                                  │
│                              ▼ 点击[开始分析]                   │
│                    ┌──────────────────────┐                    │
│                    │   AnalysisWorker     │                    │
│                    │     (QThread)        │                    │
│                    └──────────┬───────────┘                    │
│                               │                                 │
│                               ▼                                 │
│              ┌────────────────────────────────┐                │
│              │       AnalysisService          │                │
│              │ → 验证输入 → 委托给Decision    │                │
│              └────────────────┬───────────────┘                │
│                               │                                 │
│                               ▼                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    DecisionEngine                         │ │
│  │                                                           │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │ │
│  │  │TheorySelect │───▶│8大理论计算  │───▶│ConflictRslv │   │ │
│  │  │理论选择     │    │并行执行     │    │冲突解决     │   │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘   │ │
│  │         │                  │                  │           │ │
│  │         ▼                  ▼                  ▼           │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │              APIManager                             │ │ │
│  │  │  各理论AI解读 (Claude/DeepSeek/Gemini/Kimi)         │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │         │                                                 │ │
│  │         ▼                                                 │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │              AIAssistant                            │ │ │
│  │  │  生成: 摘要 / 详细分析 / 回溯 / 预测 / 建议         │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────┬───────────────────────────────┘ │
│                              │                                  │
│                              ▼ ComprehensiveReport             │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                     ProgressPanel                        │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │  │
│  │  │进度条      │  │阶段标签     │  │详细日志         │  │  │
│  │  │QProgressBar│  │QLabel       │  │QTextBrowser     │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                     ResultPanel (4个Tab)                  │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────┐│  │
│  │  │核心摘要    │ │详细分析    │ │各理论分析  │ │可视化  ││  │
│  │  │exec_summary│ │detailed    │ │theory_list │ │charts  ││  │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────┘│  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 理论选择与计算流程

```
用户输入 (UserInput)
    │
    ▼
TheorySelector.select_theories()
    │
    ├── 计算各理论信息完备度
    │   ├── 八字: min 0.75 (需年月日)
    │   ├── 紫微: min 0.95 (需年月日时辰性别)
    │   ├── 奇门: min 0.70 (需时间+问题)
    │   ├── 六壬: min 0.60 (需时间+问题)
    │   ├── 六爻: min 0.60 (需3-6个数字)
    │   ├── 梅花: min 0.30 (需数字或时间)
    │   ├── 小六壬: min 0.00 (无要求)
    │   └── 测字: min 0.50 (需汉字+问题)
    │
    ├── 计算问题匹配度 (8维特征向量)
    │   └── [时间敏感, 空间相关, 人际, 财务, 健康, 决策, 情感, 复杂]
    │
    ├── 考虑MBTI适配 (可选)
    │
    └── 返回最优理论组合 (默认最多5个)
```

### 后端功能对应

| 后端功能 | 文件位置 | 前端组件 | 实现状态 |
|----------|----------|----------|----------|
| 理论自动选择 | `core/theory_selector.py` | 无选择UI | ⚠️ 自动执行，无用户控制 |
| 八字排盘 | `theories/bazi/calculator.py` | ResultPanel | ✅ 已实现 |
| 紫微斗数 | `theories/ziwei/calculator.py` | ResultPanel | ✅ 已实现 |
| 奇门遁甲 | `theories/qimen/calculator_v2.py` | ResultPanel | ✅ 已实现 |
| 大六壬 | `theories/daliuren/calculator_v2.py` | ResultPanel | ✅ 已实现 |
| 六爻 | `theories/liuyao/theory.py` | ResultPanel | ✅ 已实现 |
| 梅花易数 | `theories/meihua/theory.py` | ResultPanel | ✅ 已实现 |
| 小六壬 | `theories/xiaoliu/theory.py` | ResultPanel | ✅ 已实现 |
| 测字术 | `theories/cezi/calculator.py` | ResultPanel | ✅ 已实现 |
| 冲突解决 | `core/conflict_resolver.py` | 无专门显示 | ❌ 未在UI呈现 |
| 双模型验证 | `api/manager.py` | 无状态显示 | ❌ 未在UI呈现 |
| 回溯分析 | `core/ai_assistant.py` | 无专门Tab | ⚠️ 合并在详细分析 |
| 预测分析 | `core/ai_assistant.py` | 无专门Tab | ⚠️ 合并在详细分析 |
| 多人八字 | `models.py` | 多人管理区 | ✅ 已实现 |
| 地理编码 | `utils/amap_geocoder.py` | GeocodeWorker | ✅ 已实现 |
| 真太阳时 | `utils/time_utils.py` | 无显示 | ❌ 未在UI呈现 |
| 数据可视化 | `utils/visualization.py` | charts Tab | ❌ 框架存在，未实现 |

### 缺失的前端功能

1. **理论选择控制** - 用户无法手动选择/排除特定理论
2. **冲突信息展示** - 多理论冲突检测结果无专门显示区
3. **回溯/预测分析Tab** - 后端有专门生成，前端合并显示
4. **双模型验证状态** - 无法看到是否启用/结果对比
5. **真太阳时显示** - 后端计算，前端无展示
6. **五行分布图/星宫图** - 可视化Tab为空
7. **置信度显示** - 各理论置信度无可视化

---

## 四、典籍标签页 (LibraryTab)

### 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                         典籍标签页                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐                                           │
│  │    左侧目录树     │                                           │
│  │   QTreeWidget    │ ──── 选择文档 ────┐                        │
│  │                  │                   │                        │
│  │  ├─ 系统资料     │                   ▼                        │
│  │  │  ├─ 八字     │         ┌──────────────────┐               │
│  │  │  ├─ 紫微     │         │   DocumentViewer │               │
│  │  │  └─ ...     │         │   Markdown渲染   │               │
│  │  └─ 用户资料    │         └────────┬─────────┘               │
│  │     └─ 导入     │                  │                         │
│  └──────────────────┘                  │                         │
│           │                            │                         │
│           ▼                            ▼                         │
│  ┌──────────────────┐        ┌──────────────────┐               │
│  │ AI学习助手按钮组  │        │  ReadingTracker  │               │
│  │                  │        │   智能阅读计时    │               │
│  │ [总结] [洞察]   │        │  (30秒无操作暂停) │               │
│  │ [方案] [心得]   │        └────────┬─────────┘               │
│  └────────┬─────────┘                 │                         │
│           │                           ▼                         │
│           ▼                  ┌──────────────────┐               │
│  ┌──────────────────┐        │UsageStatsManager │               │
│  │AIAssistantWorker │        │  记录阅读时长    │               │
│  │   (QThread)      │        └──────────────────┘               │
│  └────────┬─────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                           │
│  │   APIManager     │                                           │
│  │ (Kimi/DeepSeek)  │                                           │
│  └────────┬─────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐        ┌──────────────────┐               │
│  │  AI学习建议显示   │        │    笔记编辑区    │               │
│  │  QTextBrowser    │        │   QTextEdit     │               │
│  └──────────────────┘        └────────┬─────────┘               │
│                                       │                         │
│                                       ▼                         │
│                              ┌──────────────────┐               │
│                              │  NotesManager    │               │
│                              │   笔记保存       │               │
│                              └──────────────────┘               │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  RAG知识库问答入口                                        │  │
│  │  [知识库问答] ──▶ RAGQADialog ──▶ RAGManager            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 后端功能对应

| 后端功能 | 文件位置 | 前端组件 | 实现状态 |
|----------|----------|----------|----------|
| 文档浏览 | resources/library/ | DocumentViewer | ✅ 已实现 |
| 智能阅读计时 | ReadingTracker组件 | 内置 | ✅ 已实现 |
| 笔记管理 | `utils/notes_manager.py` | 笔记编辑区 | ✅ 已实现 |
| AI文档总结 | AIAssistantWorker | [总结]按钮 | ✅ 已实现 |
| AI深度洞察 | AIAssistantWorker | [洞察]按钮 | ✅ 已实现 |
| AI学习方案 | AIAssistantWorker | [方案]按钮 | ✅ 已实现 |
| AI心得生成 | AIAssistantWorker | [心得]按钮 | ✅ 已实现 |
| RAG知识库 | `utils/rag_manager.py` | RAGQADialog | ✅ 已实现 |
| 使用统计 | `utils/usage_stats_manager.py` | 无专门展示 | ⚠️ 记录但无展示 |
| 文档搜索 | 未实现 | 无 | ❌ 未实现 |
| 笔记导出 | 未实现 | 无 | ❌ 未实现 |
| 学习进度 | 部分实现 | 无可视化 | ❌ 未在UI呈现 |

### 缺失的前端功能

1. **文档搜索框** - 无法搜索典籍内容
2. **学习进度可视化** - 阅读时长数据无图表展示
3. **笔记导出按钮** - 无法导出笔记
4. **标签/分类系统** - 无法对笔记分类
5. **离线缓存管理** - 无离线阅读支持

---

## 五、洞察标签页 (InsightTab)

### 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                         洞察标签页                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                      数据采集层                           │  │
│  │                                                          │  │
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐    │  │
│  │  │UsageStats   │   │NotesManager │   │WarningMgr  │    │  │
│  │  │Manager      │   │笔记统计     │   │预警记录     │    │  │
│  │  │使用统计     │   │            │   │            │    │  │
│  │  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘    │  │
│  │         │                 │                 │            │  │
│  └─────────┼─────────────────┼─────────────────┼────────────┘  │
│            │                 │                 │                │
│            ▼                 ▼                 ▼                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                      卡片展示层                           │  │
│  │                                                          │  │
│  │  ┌─────────────────┐   ┌─────────────────┐              │  │
│  │  │   使用画像卡片   │   │   典籍学习卡片   │              │  │
│  │  │ ・使用频率      │   │ ・阅读次数       │              │  │
│  │  │ ・常用时段      │   │ ・文档数        │              │  │
│  │  │ ・偏好理论      │   │ ・笔记数        │              │  │
│  │  │ ・问题类型      │   │ ・学习方向       │              │  │
│  │  └─────────────────┘   └─────────────────┘              │  │
│  │                                                          │  │
│  │  ┌─────────────────┐   ┌─────────────────┐              │  │
│  │  │   状态评估卡片   │   │   使用统计卡片   │              │  │
│  │  │ ・密集使用检测   │   │ ・本周使用      │              │  │
│  │  │ ・深夜使用检测   │   │ ・历史总计      │              │  │
│  │  │ ・重复问题检测   │   │                 │              │  │
│  │  └─────────────────┘   └─────────────────┘              │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  [分析我的画像] 按钮                                      │  │
│  │         │                                                │  │
│  │         ▼                                                │  │
│  │  ┌────────────────────────┐                              │  │
│  │  │ ProfileAnalysisWorker  │                              │  │
│  │  │      (QThread)         │                              │  │
│  │  └───────────┬────────────┘                              │  │
│  │              │                                           │  │
│  │              ▼                                           │  │
│  │  ┌────────────────────────┐                              │  │
│  │  │     APIManager         │                              │  │
│  │  │   (DeepSeek模型)       │                              │  │
│  │  └───────────┬────────────┘                              │  │
│  │              │                                           │  │
│  │              ▼                                           │  │
│  │  ┌────────────────────────┐                              │  │
│  │  │   AI深度分析卡片       │                              │  │
│  │  │   300-500字个性化分析  │                              │  │
│  │  └────────────────────────┘                              │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 预警机制流程

```
用户行为检测
    │
    ├── 密集使用检测
    │   └── 6小时内 > 5次分析 → WarningLevel.PAUSE
    │
    ├── 深夜使用检测
    │   └── 22:00-06:00 使用 → WarningLevel.CARE
    │
    ├── 重复问题检测
    │   └── 同类问题 > 3次 → WarningLevel.PAUSE
    │
    └── 情绪关键词检测
        └── 高危关键词 → WarningLevel.FORCED (冷却60分钟)
            │
            ▼
    ┌───────────────────────────────────┐
    │  对应弹窗                         │
    │  CARE → CareDialog (温馨提示)     │
    │  PAUSE → PauseDialog (暂停建议)   │
    │  FORCED → ForcedCoolingDialog     │
    │           (强制冷却 + 危机热线)   │
    └───────────────────────────────────┘
```

### 后端功能对应

| 后端功能 | 文件位置 | 前端组件 | 实现状态 |
|----------|----------|----------|----------|
| 使用画像统计 | `utils/usage_stats_manager.py` | 使用画像卡片 | ✅ 已实现 |
| 学习统计 | `utils/notes_manager.py` | 典籍学习卡片 | ✅ 已实现 |
| AI画像分析 | ProfileAnalysisWorker | AI分析卡片 | ✅ 已实现 |
| 状态评估 | `utils/warning_manager.py` | 状态评估卡片 | ✅ 已实现 |
| 密集使用检测 | `utils/warning_manager.py` | 检测显示 | ✅ 已实现 |
| 深夜使用检测 | `utils/warning_manager.py` | 检测显示 | ✅ 已实现 |
| 重复问题检测 | `utils/warning_manager.py` | 检测显示 | ✅ 已实现 |
| 趋势图表 | 未实现 | 无 | ❌ 未实现 |
| 数据导出 | 部分实现 | 无按钮 | ❌ 未在UI呈现 |
| 预警历史 | 有记录 | 无查看入口 | ❌ 未在UI呈现 |

### 缺失的前端功能

1. **使用趋势图** - 无折线图/柱状图展示
2. **理论偏好饼图** - 无可视化
3. **时段分布热力图** - 无可视化
4. **数据导出按钮** - 无法导出统计数据
5. **预警历史查看** - 无法查看历史预警记录

---

## 六、历史记录标签页 (HistoryTab)

### 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                       历史记录标签页                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  操作栏                                                  │  │
│  │  [刷新] [清空] [对比选中]     🔍 搜索框                  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│                    ┌──────────────────┐                        │
│                    │  HistoryManager  │                        │
│                    │   list_reports() │                        │
│                    └────────┬─────────┘                        │
│                             │                                   │
│                             ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    history_table                         │  │
│  │  QTableWidget                                            │  │
│  │  ┌────────┬─────────┬─────────┬─────────┬──────────┐    │  │
│  │  │  时间  │  问题   │  理论   │  摘要   │   操作   │    │  │
│  │  ├────────┼─────────┼─────────┼─────────┼──────────┤    │  │
│  │  │ ...    │ ...     │ ...     │ ...     │[查看][删]│    │  │
│  │  └────────┴─────────┴─────────┴─────────┴──────────┘    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│              ┌───────────────┼───────────────┐                  │
│              │               │               │                  │
│              ▼               ▼               ▼                  │
│      点击[查看]        选中多行        点击[对比]              │
│              │          [对比选中]           │                  │
│              ▼               │               ▼                  │
│  ┌────────────────┐         │      ┌────────────────┐          │
│  │report_selected │         │      │ReportCompare   │          │
│  │     信号       │         └─────▶│   Dialog       │          │
│  └───────┬────────┘                │  (待完善)      │          │
│          │                         └────────────────┘          │
│          ▼                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    MainWindow                            │  │
│  │  _on_history_report_selected()                          │  │
│  │                                                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│  │  │切换到推演Tab│  │更新分析结果 │  │更新问道八字 │      │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 后端功能对应

| 后端功能 | 文件位置 | 前端组件 | 实现状态 |
|----------|----------|----------|----------|
| 历史记录存储 | `utils/history_manager.py` | 表格展示 | ✅ 已实现 |
| 报告搜索 | HistoryManager.search() | 搜索框 | ✅ 已实现 |
| 报告删除 | HistoryManager.delete() | [删除]按钮 | ✅ 已实现 |
| 批量清空 | HistoryManager.clear_all() | [清空]按钮 | ✅ 已实现 |
| 报告对比 | ReportCompareDialog | [对比选中] | ⚠️ 框架存在，功能待补 |
| 标签页联动 | report_selected信号 | 自动切换 | ✅ 已实现 |
| 时间范围筛选 | 未实现 | 无 | ❌ 未实现 |
| 理论类别筛选 | 未实现 | 无 | ❌ 未实现 |
| 报告导出 | 部分实现 | 无批量导出 | ⚠️ 单个可导出 |
| 报告分享 | 未实现 | 无 | ❌ 未实现 |

### 缺失的前端功能

1. **对比分析对话框** - ReportCompareDialog功能不完整
2. **时间范围筛选** - 无日期选择器
3. **理论类别筛选** - 无下拉筛选
4. **批量导出** - 无法批量导出历史报告
5. **报告分享** - 无分享功能

---

## 七、设置标签页 (SettingsTab)

### 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                         设置标签页                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  功能状态区                                              │  │
│  │  FeatureStatusWidget                                     │  │
│  │                                                          │  │
│  │  ┌────────────────────────────────────────────────────┐ │  │
│  │  │ ✓ AI对话功能    ✓ 报告导出    ✓ 主题切换         │ │  │
│  │  │ ✓ 报告自定义    ⚠️ 历史对比    ✓ 报告问答        │ │  │
│  │  │ ✓ 术语解释      ✓ AI分析服务   ...               │ │  │
│  │  └────────────────────────────────────────────────────┘ │  │
│  │                     [刷新功能状态]                       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  主题设置区                                              │  │
│  │  ThemeSettingsWidget                                     │  │
│  │                                                          │  │
│  │  ☀️ 清雅白  |  🌙 墨夜黑  |  🎨 系统跟随                │  │
│  │         │                                                │  │
│  │         ▼                                                │  │
│  │  ┌────────────────┐                                     │  │
│  │  │ theme_changed  │ ──▶ MainWindow._on_theme_changed()  │  │
│  │  │     信号       │     ──▶ ThemeManager.apply_theme()  │  │
│  │  └────────────────┘                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  API配置区                                               │  │
│  │                                                          │  │
│  │  Claude:   [API密钥输入框] [测试连接]                    │  │
│  │  Gemini:   [API密钥输入框] [测试连接]                    │  │
│  │  DeepSeek: [API密钥输入框] [测试连接]                    │  │
│  │  Kimi:     [API密钥输入框] [测试连接]                    │  │
│  │                                                          │  │
│  │  优先级设置: [未实现]                                    │  │
│  │                                                          │  │
│  │                     [保存配置]                           │  │
│  │                         │                                │  │
│  │                         ▼                                │  │
│  │                ┌────────────────┐                        │  │
│  │                │ ConfigManager  │                        │  │
│  │                │ save_config()  │                        │  │
│  │                └────────────────┘                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  报告自定义                                              │  │
│  │  [打开报告自定义] ──▶ ReportCustomDialog                │  │
│  │                                                          │  │
│  │  ┌────────────────────────────────────────────────────┐ │  │
│  │  │ 用户描述需求 ──▶ AI生成模板 ──▶ 保存为自定义模板  │ │  │
│  │  └────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  帮助与关于                                              │  │
│  │  HelpWidget + AboutDialog                               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 后端功能对应

| 后端功能 | 文件位置 | 前端组件 | 实现状态 |
|----------|----------|----------|----------|
| 配置管理 | `utils/config_manager.py` | 保存按钮 | ✅ 已实现 |
| 配置验证 | `utils/config_validator.py` | 保存时验证 | ✅ 已实现 |
| 主题管理 | `utils/theme_manager.py` | 主题选择 | ✅ 已实现 |
| 功能状态监控 | FeatureStatusWidget | 状态显示 | ✅ 已实现 |
| API密钥存储 | ConfigManager | 输入框 | ✅ 已实现 |
| API连接测试 | 未实现 | [测试]按钮 | ❌ 未实现 |
| API优先级 | API_PRIORITY常量 | 无UI控制 | ❌ 未在UI呈现 |
| 报告模板自定义 | `utils/template_manager.py` | 对话框 | ⚠️ 基础框架 |
| 密钥加密存储 | `utils/crypto.py` | 无明确提示 | ⚠️ 后台实现 |
| 日志级别配置 | 未暴露 | 无 | ❌ 未在UI呈现 |
| 数据隐私设置 | 部分实现 | 无专门区域 | ❌ 未在UI呈现 |

### 缺失的前端功能

1. **API连接测试** - 无法验证密钥有效性
2. **API优先级排序** - 无法调整API使用顺序
3. **双模型验证开关** - 无法启用/禁用
4. **日志级别配置** - 无法调整日志详细度
5. **数据隐私设置区** - 无数据导出/删除控制
6. **主题自定义** - 无法自定义颜色

---

## 八、后端功能未呈现汇总

### 8.1 计算引擎层

| 未呈现功能 | 后端位置 | 建议UI位置 | 优先级 |
|------------|----------|------------|--------|
| 理论手动选择 | TheorySelector | 推演-输入面板 | 🔴 高 |
| 理论完备度显示 | get_info_completeness() | 推演-输入面板 | 🟡 中 |
| 冲突检测结果 | ConflictResolver | 推演-结果面板 | 🔴 高 |
| 置信度可视化 | confidence字段 | 推演-结果面板 | 🟡 中 |
| 真太阳时显示 | TimeUtils | 推演-输入面板 | 🟢 低 |
| 时辰不确定处理 | birth_time_certainty | 问道-对话流 | 🟡 中 |

### 8.2 AI服务层

| 未呈现功能 | 后端位置 | 建议UI位置 | 优先级 |
|------------|----------|------------|--------|
| 双模型验证状态 | enable_dual_verification | 设置标签页 | 🟡 中 |
| API故障转移提示 | _call_with_failover | 进度面板 | 🟢 低 |
| 模型选择建议 | API_USAGE_MAP | 设置标签页 | 🟢 低 |
| API使用统计 | 未记录 | 洞察标签页 | 🟢 低 |

### 8.3 数据分析层

| 未呈现功能 | 后端位置 | 建议UI位置 | 优先级 |
|------------|----------|------------|--------|
| 使用趋势图表 | UsageStatsManager | 洞察标签页 | 🔴 高 |
| 理论偏好可视化 | 统计数据 | 洞察标签页 | 🟡 中 |
| 预警历史查看 | WarningManager | 洞察标签页 | 🟡 中 |
| 学习进度图表 | NotesManager | 典籍标签页 | 🟡 中 |

### 8.4 报告功能

| 未呈现功能 | 后端位置 | 建议UI位置 | 优先级 |
|------------|----------|------------|--------|
| 回溯分析专区 | retrospective_analysis | 推演-结果Tab | 🟡 中 |
| 预测分析专区 | predictive_analysis | 推演-结果Tab | 🟡 中 |
| 五行分布图 | visualization.py | 推演-可视化Tab | 🔴 高 |
| 星宫排盘图 | visualization.py | 推演-可视化Tab | 🔴 高 |
| 报告对比功能 | ReportCompareDialog | 历史标签页 | 🔴 高 |

### 8.5 用户交互

| 未呈现功能 | 后端位置 | 建议UI位置 | 优先级 |
|------------|----------|------------|--------|
| MBTI选择器 | mbti_analyzer.py | 问道/推演 | 🟡 中 |
| 测字输入入口 | CeZiTheory | 问道标签页 | 🟡 中 |
| 语音输入 | 未实现 | 问道标签页 | 🟢 低 |
| 文档搜索 | 未实现 | 典籍标签页 | 🔴 高 |

---

## 九、数据流总表

| 功能模块 | 数据流向 |
|----------|----------|
| **问道** | 用户输入 → NLPParser → ConversationService(5阶段) → APIManager → ChatWidget显示 |
| **推演** | InputPanel → AnalysisWorker → DecisionEngine → (理论计算+AI解读) → ResultPanel |
| **典籍** | 目录选择 → DocumentViewer → ReadingTracker → UsageStats + NotesManager |
| **洞察** | UsageStats + Notes + Warning → 卡片展示 → AI分析(可选) |
| **历史** | HistoryManager → TableWidget → (选中)report_selected信号 → 其他Tab联动 |
| **设置** | ConfigManager ↔ UI控件 → 保存/应用 → 功能状态刷新 |

---

## 十、建议的UI重构优先级

### 第一优先级（核心体验）

1. **推演-可视化Tab实现** - 五行分布图、星宫排盘图
2. **推演-冲突信息展示** - 多理论冲突检测结果
3. **推演-理论选择控制** - 允许用户手动选择理论
4. **历史-对比分析功能** - 完善ReportCompareDialog

### 第二优先级（功能完善）

5. **洞察-数据可视化** - 使用趋势、理论偏好图表
6. **典籍-文档搜索** - 添加搜索框
7. **设置-API连接测试** - 验证密钥有效性
8. **问道-MBTI选择器** - 个性化对话体验

### 第三优先级（锦上添花）

9. **设置-双模型验证开关** - 用户可控
10. **洞察-预警历史** - 查看历史预警记录
11. **典籍-学习进度图表** - 可视化学习数据
12. **推演-真太阳时显示** - 精确时间信息

---

*文档生成时间: 2026-01-06*
*版本: v1.0*
