# 回溯验证方法论优化 - 2026-01-09

## 问题描述

### 用户反馈
用户指出现有的回溯验证问题**太模糊、无法落地验证**：

**❌ 原问题示例**：
```
1. 过去3年中，在事业领域是否有重大变化？
2. 您最近一次重要决策是在什么时候？
3. 过去一年的发展是否符合您的预期？
```

**问题分析**：
- ❌ "重大变化"定义不明确，用户难以判断什么算"重大"
- ❌ "最近一次重要决策"要求用户回忆时间点，不是在验证预测
- ❌ "是否符合预期"在问用户的主观预期，不是验证算命准确性

### 用户建议
> 正常是问某个时刻是否经历某种事情或者变化，让用户回答**符合、部分符合或者不符合**。

---

## 根本原因分析

### 方法论错误

**现有逻辑**（错误）：
```
生成模糊的开放式问题 → 让用户回忆历史 → 无法量化验证
```

**正确逻辑**：
```
分析结果预测 → 转换为具体历史事件 → 用户确认是否发生 → 量化准确率
```

### 核心差异

| 维度 | 错误方法 | 正确方法 |
|------|---------|---------|
| **出发点** | 凭空提问 | **基于分析结果反推** |
| **问题类型** | 开放式问题 | **封闭式验证** |
| **时间范围** | 模糊（"过去几年"） | **精确（2023年、春季）** |
| **事件描述** | 抽象（"重大变化"） | **具体（跳槽、分手、亏损）** |
| **答案格式** | 自由文本 | **三选项（符合/部分符合/不符合）** |
| **验证目的** | 收集信息 | **验证预测准确性** |

---

## 修复方案

### 1. 优化 AI Prompt（questions_gen.md）

#### 新增核心方法论
```markdown
### 验证原则
**从分析结果推导出具体的、可验证的历史事件，让用户确认是否发生过**。

### 问题生成步骤
1. **提取预测点**：从分析结果中找出关键预测
2. **转换为事件**：将预测转换为具体事件
3. **定位时间**：明确时间范围（具体到年份、季度或月份）
4. **构建问题**：按照"在XX时间，是否经历过XX事件？"格式
5. **三选项答题**：符合 / 部分符合 / 不符合
```

#### 对比示例

**❌ 错误示例**（太模糊）：
```
1. 过去3年中，在事业领域是否有重大变化？
2. 您最近一次重要决策是在什么时候？
3. 过去一年的发展是否符合您的预期？
```

**✅ 正确示例**（具体可验证）：
```
1. 2023年下半年（7-12月），是否经历过工作上的明显挫折或不顺利？
2. 2024年春季（3-5月），感情关系是否出现过矛盾或短暂分离？
3. 2022年，是否有过意外的财务支出或投资亏损？
```

#### 基于分析结果生成规则
```markdown
- 如果分析说"近期有贵人相助"
  → 问："过去3个月，是否遇到过对您事业有重大帮助的人？"

- 如果分析说"去年财运不佳"
  → 问："2023年是否经历过明显的财务困难或收入下降？"

- 如果分析说"今年感情有波折"
  → 问："2024年上半年，感情关系是否出现过争吵或冷战？"
```

#### 新输出格式
```json
[
    {
        "question": "2023年下半年（7-12月），工作上是否经历过明显的挫折或不顺利？",
        "type": "three_choice",
        "options": ["符合", "部分符合", "不符合"],
        "purpose": "验证'去年事业有坎坷'的预测",
        "expected_answer": "符合",
        "weight": 1.2
    }
]
```

---

### 2. 优化代码模板（dynamic_verification.py）

#### 修改前（开放式问题）
```python
QUESTION_TEMPLATES = {
    "事业": [
        "在过去3年内，您是否经历过工作变动（换工作、升职、降职等）？",
        "您最近一次重要的事业决策是在哪一年？",
        "在2020-2024年间，您的收入是否有明显增长？"
    ],
    # ...
}
```

#### 修改后（三选项格式）
```python
QUESTION_TEMPLATES = {
    "事业": [
        ("2023年下半年（7-12月），工作上是否经历过明显的挫折或不顺利？", "验证事业运势"),
        ("2024年上半年（1-6月），是否有过跳槽、换岗位或工作内容调整的情况？", "验证事业变动"),
        ("2022-2023年间，是否遇到过对工作有重要帮助的贵人（领导/同事/合作伙伴）？", "验证贵人运")
    ],
    "感情": [
        ("2023年全年，感情关系是否出现过争吵、冷战或短暂分离？", "验证感情波折"),
        ("2024年春季（3-5月），是否有过新的感情机会或桃花出现？", "验证桃花运"),
        # ...
    ],
    # ...
}
```

#### 答案评估逻辑更新
```python
def evaluate_answer(self, question: VerificationQuestion, answer: str) -> bool:
    """评估用户答案是否验证通过（支持三选项格式）"""

    if question.question_type == "three_choice":
        # "符合"和"部分符合"都算验证通过
        if answer_normalized in ["符合", "部分符合"]:
            return True
        # "不符合"算验证失败
        elif answer_normalized == "不符合":
            return False
        # 其他答案尝试模糊匹配
        else:
            # 包含积极关键词 → 视为"符合"
            positive_keywords = ["是的", "确实", "有过", "经历过", "发生过"]
            if any(kw in answer_normalized for kw in positive_keywords):
                return True
            # 包含消极关键词 → 视为"不符合"
            negative_keywords = ["没有", "不是", "未曾", "没经历"]
            if any(kw in answer_normalized for kw in negative_keywords):
                return False
            # 默认视为部分符合
            return True
```

---

### 3. 优化用户提示（verification_prompt.md）

#### 修改前
```markdown
## ⏪ 回溯验证

为了验证分析的准确性，请回答以下问题：

${verification_questions}

**说明**：回溯验证可以帮助我们调整各理论的权重，提高分析准确度。

如果没有特别的变化，可以回答"最近几年比较平稳"。
```

#### 修改后
```markdown
## ⏪ 回溯验证

为了验证分析的准确性，请根据实际情况回答以下问题：

${verification_questions}

**答题说明**：
- **符合**：确实发生过，与描述基本一致
- **部分符合**：有类似情况，但不完全吻合
- **不符合**：没有发生过此类情况

**提示**：回溯验证帮助系统评估预测准确度，您的真实反馈有助于优化分析模型。
```

---

## 修复效果

### 问题质量对比

#### 场景：事业咨询

**修复前** ❌：
```
Q1: 过去3年中，在事业领域是否有重大变化？
分析：什么算"重大"？用户难以判断
答案：开放文本，无法量化

Q2: 您最近一次重要决策是在什么时候？
分析：要求回忆时间，不是验证预测
答案：年份，无法对应分析结果

Q3: 过去一年的发展是否符合您的预期？
分析：问用户预期，不是验证算命
答案：主观感受，无参考价值
```

**修复后** ✅：
```
Q1: 2023年下半年（7-12月），工作上是否经历过明显的挫折或不顺利？
分析：基于分析结果"去年事业有坎坷"反推
事件：具体明确（挫折、不顺利）
时间：精确（2023年下半年）
答案：符合 / 部分符合 / 不符合

Q2: 2024年上半年（1-6月），是否有过跳槽、换岗位或工作内容调整的情况？
分析：基于分析结果"今年事业有变动"反推
事件：具体明确（跳槽、换岗、调整）
时间：精确（2024年上半年）
答案：符合 / 部分符合 / 不符合

Q3: 2022-2023年间，是否遇到过对工作有重要帮助的贵人（领导/同事/合作伙伴）？
分析：基于分析结果"有贵人相助"反推
事件：具体明确（遇到贵人）
时间：精确（2022-2023年间）
答案：符合 / 部分符合 / 不符合
```

### 验证流程改进

**修复前流程**：
```
AI分析 → 生成模糊问题 → 用户回答 → 无法量化准确率
```

**修复后流程**：
```
AI分析 → 提取预测点 → 反推历史事件 → 用户确认 → 计算准确率
       ↓
   "去年事业有坎坷"
       ↓
   "2023年下半年是否有挫折？"
       ↓
   用户：符合 / 部分符合 / 不符合
       ↓
   准确率统计 + 置信度调整
```

---

## 方法论总结

### 回溯验证的正确姿势

#### 1. 基于预测反推事件
```
❌ 错误：凭空生成问题
✅ 正确：从分析结果推导历史事件
```

#### 2. 时间精确到点
```
❌ 错误："过去几年"、"最近"
✅ 正确："2023年下半年"、"2024年春季"
```

#### 3. 事件具体可验证
```
❌ 错误："重大变化"、"重要决策"
✅ 正确："跳槽"、"分手"、"投资亏损"
```

#### 4. 三选项标准答题
```
❌ 错误：开放文本、是/否问题
✅ 正确：符合 / 部分符合 / 不符合
```

#### 5. 可量化准确率
```
✅ 3个问题，用户答：符合、符合、不符合
✅ 准确率：2/3 = 66.7%
✅ 置信度调整：+8% (基于权重计算)
```

---

## 技术实现

### AI Prompt 关键点
1. **明确方法论**：详细说明问题生成步骤
2. **正反示例**：给出错误和正确的对比
3. **强制格式**：要求 type="three_choice"、options固定
4. **权重设置**：核心预测 weight=1.0-1.5，次要预测 weight=0.5-0.8

### 代码实现关键点
1. **模板结构**：元组格式 `(问题文本, 验证目的)`
2. **问题类型**：固定为 `three_choice`
3. **答案评估**：支持精确匹配和模糊匹配
4. **置信度计算**：基于权重的准确率计算

---

## 验证结果

### 语法检查
```bash
$ cd cyber_mantic && python -m py_compile core/dynamic_verification.py
# ✅ 通过
```

### 预期效果

**用户体验**：
- ✅ 问题明确，容易回答
- ✅ 时间精确，方便回忆
- ✅ 三选项快速作答
- ✅ 验证目的清晰

**系统效果**：
- ✅ 准确率可量化
- ✅ 置信度可调整
- ✅ 理论权重可优化
- ✅ 用户信任度提升

---

## 影响范围

### 修改文件
1. `prompts/verification/questions_gen.md` - AI 生成逻辑优化（+97 行）
2. `core/dynamic_verification.py` - 代码模板和评估逻辑优化（+58 行修改）
3. `prompts/conversation/verification_prompt.md` - 用户提示优化（+6 行）

### 受益场景
- ✅ 所有回溯验证场景
- ✅ AI 生成问题（主路径）
- ✅ 模板生成问题（备用路径）
- ✅ 答案评估和准确率计算

---

## 待优化点

### 已识别问题（用户新反馈）
1. **时间跨度不匹配**：
   - 问题：用户问"这辈子能不能升官发财"，系统只给1年分析
   - 待解决：时间线应该根据问题动态调整（5年、10年、长期）

2. **时间线未个性化**：
   - 问题：固定模板"近期（1-3个月）、中期（3-12个月）"
   - 待解决：根据用户问题的时间跨度动态生成时间线

---

## 经验教训

### 1. 方法论比技术更重要
- ❌ 错误：直接写代码生成问题
- ✅ 正确：先明确验证方法论，再实现代码

### 2. 用户反馈要深入理解
- 用户说"问题太模糊"不只是措辞问题
- 本质是**验证逻辑错误**：凭空提问 vs 基于预测反推

### 3. 具体化是关键
- 时间具体化：2023年 vs 过去几年
- 事件具体化：跳槽 vs 重大变化
- 答案具体化：三选项 vs 开放文本

### 4. 闭环验证设计
```
分析预测 → 历史验证 → 准确率计算 → 模型优化
    ↑                                    ↓
    └────────────────────────────────────┘
```

---

## 修复状态

- ✅ 问题根因已识别（方法论错误）
- ✅ AI Prompt 已优化（新增方法论指导）
- ✅ 代码模板已优化（三选项格式）
- ✅ 答案评估已优化（支持三选项）
- ✅ 用户提示已优化（答题说明）
- ✅ 语法检查通过
- ⏳ 待集成测试验证
- ⏳ 待用户反馈确认

---

**修复时间**: 2026-01-09 23:00
**修复作者**: Claude Code
**文件变更**: 3 个文件，+161 行新增/修改
**严重程度**: 🟠 High（影响核心验证逻辑）
**修复类型**: ♻️ Refactor（方法论重构 + 格式标准化）
**关键突破**: 从"凭空提问"转变为"基于预测反推"
