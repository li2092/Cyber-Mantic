# 前端重构实施方案

## 📋 重构目标

1. **暴露后端功能**：让用户能访问所有已实现的AI智能功能
2. **改善架构**：解耦UI和业务逻辑，提高可维护性
3. **增强交互**：添加对话式交互，提升用户体验
4. **新增AI对话模式**：实现9步智能交互式分析流程

---

## 🏗️ 新架构设计

### 整体结构

```
cyber_mantic/
├── services/               # ✨ 新增：业务逻辑服务层
│   ├── __init__.py
│   ├── analysis_service.py      # 分析流程服务
│   ├── report_service.py        # 报告交互服务
│   ├── conversation_service.py  # 纯AI对话服务
│   └── export_service.py        # 导出服务
│
├── ui/
│   ├── main_window.py     # 主窗口（简化后）
│   │
│   ├── dialogs/           # ✨ 新增：对话框组件
│   │   ├── __init__.py
│   │   ├── chat_dialog.py          # 通用聊天对话框
│   │   ├── report_qa_dialog.py     # 报告问答对话框
│   │   ├── term_explain_dialog.py  # 术语解释弹窗
│   │   ├── report_compare_dialog.py# 报告对比对话框
│   │   ├── export_dialog.py        # 导出选项对话框
│   │   └── report_custom_dialog.py # 报告自定义对话框
│   │
│   ├── tabs/              # ✨ 新增：标签页模块
│   │   ├── __init__.py
│   │   ├── analysis/               # 分析标签页（模块化重构）
│   │   │   ├── __init__.py
│   │   │   ├── analysis_tab.py     # 主控制器
│   │   │   ├── input_panel.py      # 输入面板组件
│   │   │   ├── progress_panel.py   # 进度面板组件
│   │   │   ├── result_panel.py     # 结果面板组件
│   │   │   └── workers.py          # 工作线程
│   │   ├── analysis_tab.py         # 向后兼容re-export
│   │   ├── ai_conversation_tab.py  # 纯AI对话标签页
│   │   ├── settings_tab.py         # 设置标签页
│   │   └── history_tab.py          # 历史记录标签页
│   │
│   ├── widgets/           # ✨ 新增：可复用组件
│   │   ├── __init__.py
│   │   ├── chat_widget.py          # 聊天消息组件
│   │   ├── progress_widget.py      # 进度显示组件
│   │   └── report_viewer_widget.py # 报告查看组件
│   │
│   ├── report_renderer.py           # 保留：报告渲染器
│   ├── report_renderer_enhanced.py  # 保留：增强渲染器
│   └── themes_simplified.py         # 保留：主题定义
│
├── core/                  # 保持不变
├── api/                   # 保持不变
├── theories/              # 保持不变
├── utils/                 # 保持不变
└── models.py              # 保持不变
```

---

## 🎯 核心新功能设计

### 1. 纯AI对话模式（9步流程）

**UI设计**：

```
┌─────────────────────────────────────────────────────┐
│  AI智能对话模式                              [保存] [新对话] │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [聊天消息区域 - 可滚动]                               │
│                                                     │
│  🤖 欢迎使用赛博玄数AI智能对话模式...                │
│                                                     │
│  👤 我是1990年5月20日下午3点出生的...               │
│                                                     │
│  🤖 [步骤1/9] 正在排八字命盘...                       │
│      ████████░░░░░░░░ 60%                          │
│                                                     │
│  🤖 分析完成！您是...                               │
│                                                     │
├─────────────────────────────────────────────────────┤
│  [输入框]                                     [发送] │
└─────────────────────────────────────────────────────┘
```

**实现类**：`ui/tabs/ai_conversation_tab.py`

**关键特性**：
- 流式进度显示（异步更新）
- 支持保存对话历史
- 支持重新发起对话
- 集成9步流程：
  1. 收集用户输入
  2. Kimi解析时间
  3. 八字分析
  4. 奇门分析
  5. 六壬分析
  6. 综合分析
  7. 补充占卜（可选）
  8. 反馈确认
  9. 问答交互

---

### 2. 报告交互功能

#### 2.1 术语解释

**触发方式**：
1. 鼠标悬停在术语上时显示图标
2. 点击图标弹出解释

**UI设计**：

```
┌──────────────────────────┐
│  术语解释                 │
├──────────────────────────┤
│  **用神**                │
│                          │
│  用神是八字命理中...       │
│  （50-100字解释）         │
│                          │
│  [我知道了]               │
└──────────────────────────┘
```

**实现**：
- 自动识别报告中的专业术语（200+术语词典）
- 点击触发调用`report_service.explain_term()`
- 弹窗显示解释

#### 2.2 报告问答

**触发方式**：在报告查看界面添加"提问"按钮

**UI设计**：

```
┌─────────────────────────────────────┐
│  报告问答                      [×]  │
├─────────────────────────────────────┤
│  [聊天消息区域]                      │
│                                     │
│  💡 建议的问题：                     │
│  • 为什么说我2019年有财务损失？       │
│  • 如何化解不利的影响？              │
│  • 具体应该什么时候行动？            │
│                                     │
│  👤 为什么说我今年财运不好？          │
│                                     │
│  🤖 根据您的八字分析...              │
│                                     │
├─────────────────────────────────────┤
│  [输入框]                     [发送] │
└─────────────────────────────────────┘
```

**实现类**：`ui/dialogs/report_qa_dialog.py`

**关键特性**：
- 基于报告内容生成建议问题（3-5个）
- 调用`report_service.answer_question()`
- 支持多轮对话
- 保留对话历史

#### 2.3 报告对比

**触发方式**：在历史记录中选择两个报告后点击"对比"

**UI设计**：

```
┌──────────────────────────────────────────────┐
│  报告对比                             [×]  │
├──────────────────────────────────────────────┤
│  📊 报告1：2024-12-01 事业发展                │
│  📊 报告2：2024-12-25 事业发展                │
│                                              │
│  ## 对比分析                                 │
│                                              │
│  ### 趋势变化                                │
│  整体趋势向好...                             │
│                                              │
│  ### 关键差异                                │
│  主要差异在于...                             │
│                                              │
│  ### 建议调整                                │
│  您应该...                                   │
│                                              │
│  [关闭]                                      │
└──────────────────────────────────────────────┘
```

**实现类**：`ui/dialogs/report_compare_dialog.py`

---

### 3. 报告自定义设置

**位置**：设置标签页新增"报告自定义"分组

**UI设计**：

```
┌────────────────────────────────────────┐
│  报告自定义设置                         │
├────────────────────────────────────────┤
│  □ 使用自定义报告模板                   │
│                                        │
│  [自定义模板内容]                       │
│  ┌───────────────────────────────┐    │
│  │ 我希望报告包含：                │    │
│  │ 1. 过去5年的回顾                │    │
│  │ 2. 未来3年的预测                │    │
│  │ 3. 每个月的运势变化              │    │
│  │ 4. 使用白话文，少用术语          │    │
│  └───────────────────────────────┘    │
│                                        │
│  [让AI生成模板]  [应用模板]  [重置]     │
│                                        │
│  ---预览---                            │
│  报告将包含以下模块：                   │
│  • 五年回顾分析 (2019-2024)            │
│  • 三年趋势预测 (2025-2027)            │
│  • 月度运势详解                        │
│  • 通俗化语言解读                      │
└────────────────────────────────────────┘
```

**实现逻辑**：
1. 用户输入需求描述
2. 点击"让AI生成模板"
3. 调用Kimi解析需求，生成prompt模板
4. 应用后，后续分析使用自定义模板

---

### 4. 暴露隐藏功能

#### 4.1 PDF导出

**实现**：在报告查看界面添加"导出"菜单

```
[保存 ▼]
 ├─ 保存为JSON
 ├─ 导出为PDF
 └─ 导出为Markdown
```

**调用**：`export_service.export_to_pdf()`

#### 4.2 主题切换

**位置**：设置标签页新增"外观"分组

```
┌──────────────────┐
│  外观设置         │
├──────────────────┤
│  主题：           │
│  ○ 清雅白（日间） │
│  ● 墨夜黑（夜间） │
│  ○ 禅意灰（阅读） │
│                  │
│  □ 自动切换       │
│    (6:00-18:00日间)│
└──────────────────┘
```

**调用**：`theme_manager.set_theme()`

#### 4.3 报告对比

见上文2.3

---

## 🔧 技术实现细节

### 异步UI更新机制

所有AI调用都是异步的，需要在PyQt6中正确处理：

```python
class AnalysisWorker(QThread):
    progress_signal = pyqtSignal(str, str, int)  # (stage, message, progress)

    def run(self):
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)

        async def async_work():
            service = ConversationService(self.api_manager)
            message = await service.start_conversation(
                progress_callback=self.emit_progress
            )
            return message

        result = loop.run_until_complete(async_work())
        loop.close()

        self.finished.emit(result)

    def emit_progress(self, stage, message, progress):
        self.progress_signal.emit(stage, message, progress)
```

### 术语识别算法

使用正则表达式 + 词典匹配：

```python
# 200+术语词典（已在report_service.py中实现）
common_terms = {"用神", "喜神", "忌神", ...}

# 自动标记
def mark_terms(text):
    for term in common_terms:
        text = re.sub(
            rf'\b{re.escape(term)}\b',
            f'<term data-term="{term}">{term}</term>',
            text
        )
    return text
```

### 进度条实时更新

```python
# 服务层
async def analyze(..., progress_callback):
    progress_callback("理论选择", "正在选择最佳理论组合...", 10)
    ...
    progress_callback("八字分析", "正在排四柱命盘...", 30)
    ...

# UI层
def on_progress(stage, message, progress):
    self.progress_bar.setValue(progress)
    self.status_label.setText(f"[{stage}] {message}")
```

---

## 📅 实施计划

### 阶段1：基础设施 ✅ 已完成
- [x] 创建services层
- [x] ConversationService（9步流程）
- [x] ReportService（术语解释、问答、对比）
- [x] AnalysisService、ExportService

### 阶段2：对话组件 🚧 进行中
- [ ] 创建ui/dialogs/目录
- [ ] ChatDialog通用聊天组件
- [ ] ReportQADialog报告问答对话框
- [ ] TermExplainDialog术语解释弹窗

### 阶段3：纯AI对话标签页
- [ ] 创建ui/tabs/ai_conversation_tab.py
- [ ] 集成ConversationService
- [ ] 实现流式进度显示
- [ ] 添加保存/新对话功能

### 阶段4：报告自定义
- [ ] 在设置页添加报告自定义UI
- [ ] AI模板生成功能
- [ ] 模板应用逻辑

### 阶段5：暴露隐藏功能
- [ ] PDF/Markdown导出菜单
- [ ] 主题切换UI
- [ ] 报告对比功能

### 阶段6：主窗口重构
- [ ] 拆分main_window.py为模块
- [ ] 提取tabs/目录
- [ ] 清理冗余代码

---

## 🎨 UI/UX改进点

### 信息架构优化

**当前**：
```
[分析] [设置] [历史]
```

**优化后**：
```
[快速分析] [AI对话] [我的报告] [设置]
```

### 报告查看改进

**当前**：3个静态标签页（摘要/详细/理论）

**优化后**：
- 单页滚动式报告
- 右侧固定"问我"按钮
- 术语可点击
- 底部建议问题卡片

### 进度提示优化

**当前**：简单进度条

**优化后**：
- 分阶段进度（1/5 → 2/5 → ...）
- 当前任务描述
- 预估剩余时间
- 异步加载动画

---

## 📊 性能优化

1. **并发分析**：八字、奇门、六壬可并发计算
2. **缓存机制**：相同参数的排盘结果缓存
3. **懒加载**：历史记录分页加载
4. **异步渲染**：大型报告分段渲染

---

## 🧪 测试计划

### 单元测试
- [ ] services/各服务类的方法测试
- [ ] 异步函数测试（pytest-asyncio）

### 集成测试
- [ ] 9步对话流程完整测试
- [ ] 报告生成→问答→对比流程测试

### UI测试
- [ ] 对话框交互测试
- [ ] 进度更新测试
- [ ] 主题切换测试

---

## 📝 文档计划

- [ ] 用户手册：AI对话模式使用指南
- [ ] 开发文档：services层API文档
- [ ] 贡献指南：如何添加新的对话功能

---

## 🚀 预期收益

### 用户价值
1. **功能可见性提升**：从27% → 100%
2. **交互体验提升**：静态报告 → 动态对话
3. **个性化程度提升**：标准报告 → 自定义报告

### 开发价值
1. **代码可维护性**：烟囱式 → 分层架构
2. **可测试性**：UI/逻辑耦合 → 独立测试
3. **可扩展性**：添加功能从修改1307行 → 新增独立模块

### 商业价值
1. **差异化竞争力**：AI对话式交互（市场上少见）
2. **用户留存率**：报告问答增加使用时长
3. **付费转化率**：展示AI能力提升价值感知

---

*文档版本*：v1.0
*最后更新*：2025-12-31
*作者*：Claude Code
