# 赛博玄数 (Cyber Numerology)

> 多理论术数智能回溯与预测系统

一个尊重隐私、精准灵活的中国传统术数融合系统，通过串联多个术数理论（黑盒），以最小用户输入实现高准确度的回溯与预测。

## ✨ 核心特性

- **最小信息输入**：不知道出生时辰也能使用，通过多理论补充
- **多理论交叉验证**：3-5个理论互相印证，提高准确性和可信度
- **智能动态选择**：根据用户提供的信息自动选择最适合的理论组合
- **渐进式交互**：在分析过程中智能提问，逐步细化结果
- **计算与解读分离**：术数计算由代码实现，解读由大模型负责，避免算错八字
- **多AI提供商支持**：支持Claude/Gemini/Deepseek/Kimi，智能故障转移 🆕
- **双模型验证**：主副模型交叉验证，提高分析可靠性 🆕
- **完整神煞系统**：12种重要神煞自动计算与分析 🆕
- **4级冲突解决**：智能处理多理论结果差异 🆕
- **智能地点查询**：高德地图API集成，自动获取出生地经纬度 🆕

## 🎯 支持的术数理论

| 理论 | 类型 | 最低信息需求 | 适用场景 |
|-----|------|-------------|---------|
| 八字 | 命理类 | 出生年月日 | 一生运势、性格分析 |
| 小六壬 | 快速类 | 随机数字/时间 | 快速吉凶判断 |
| 奇门遁甲 | 占卜类 | 当前时间 | 具体事件决策 |
| 梅花易数 | 快速类 | 随机数/外应 | 快速吉凶判断 |
| 六爻 | 占卜类 | 随机数字 | 具体问题占断 |
| 紫微斗数 | 命理类 | 出生年月日时 | 一生格局分析 |
| 大六壬 | 占卜类 | 当前时间 | 事态过程预测 |
| 测字术 | 快速类 | 一个汉字 | 心理状态解读 |

*当前版本已实现：**八字、小六壬、梅花易数、六爻、奇门遁甲、紫微斗数、大六壬、测字术**（全部8个理论）*

## 📦 安装

### 1. 环境要求

- Python 3.8+
- Windows 11 / macOS / Linux

### 2. 安装依赖

```bash
cd cyber_mantic
pip install -r requirements.txt
```

### 3. 配置API密钥

复制环境变量模板：

```bash
cp .env.example .env
```

编辑 `.env` 文件，填入你的API密钥（至少配置一个）：

```env
# AI提供商API密钥（至少配置一个）
CLAUDE_API_KEY=your_claude_api_key_here
GEMINI_API_KEY=your_gemini_api_key_here
DEEPSEEK_API_KEY=your_deepseek_api_key_here
KIMI_API_KEY=your_kimi_api_key_here
```

**多AI提供商优势**：
- **Claude (Anthropic)**：高质量深度解读，适合命理分析
- **Gemini (Google)**：Google最新模型，速度快
- **Deepseek**：成本优化，适合快速响应
- **Kimi (Moonshot)**：国内大模型，网络稳定

系统会按优先级自动选择（claude > gemini > deepseek > kimi），某个API失败时自动切换到下一个可用API。

## 🚀 快速开始

### 命令行模式（示例）

```bash
python main.py
```

这将运行一个内置的示例分析。

### 交互模式

```bash
python main.py --interactive
```

按照提示输入您的信息，系统将自动选择合适的理论进行分析。

### GUI桌面界面 🆕

```bash
python gui.py
```

启动PyQt6桌面界面，提供可视化的交互体验：
- 图形化输入表单
- 实时分析进度显示
- 多标签页结果展示
- 报告保存功能

**注意**：需要安装PyQt6：`pip install PyQt6`

### 作为Python模块使用

```python
import asyncio
from datetime import datetime
from models import UserInput
from core import DecisionEngine

# 加载配置
config = {...}  # 从config.yaml加载

# 创建决策引擎
engine = DecisionEngine(config)

# 创建用户输入
user_input = UserInput(
    question_type="事业",
    question_description="我想知道2025年的事业运势如何",
    birth_year=1990,
    birth_month=6,
    birth_day=15,
    numbers=[3, 7, 5],
    current_time=datetime.now()
)

# 执行分析
report = asyncio.run(engine.analyze(user_input))

# 查看结果
print(report.executive_summary)
```

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────┐
│              用户界面层 (UI Layer)                │
│        信息输入 │ 进度展示 │ 报告展示             │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│           决策引擎层 (Decision Engine)            │
│    理论选择器 │ 冲突解决器 │ 报告生成器           │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│          术数计算层 (Calculation Layer)           │
│   八字 │ 奇门遁甲 │ 梅花易数 │ 小六壬 │ ...       │
│         [纯代码实现，无LLM参与]                   │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│          AI解读层 (AI Interpretation)             │
│   Claude │ Gemini │ Deepseek │ Kimi             │
│   [智能故障转移 + 双模型验证]                      │
└─────────────────────────────────────────────────┘
```

## 📋 核心设计原则

1. **计算与解读分离**：所有干支排盘、神煞计算由代码实现，结果可追溯验证
2. **隐私优先**：仅收集术数分析必需信息，支持匿名使用，数据加密存储
3. **文化尊重**：严格遵循各术数理论传统范式，不随意混合或篡改
4. **渐进确认**：适时释放部分分析结果，让用户确认或纠正

## 📊 理论选择算法

系统通过三个维度计算理论适配度：

1. **信息完备度**（40%权重）：用户提供的信息对该理论是否充分
2. **问题匹配度**（35%权重）：该理论是否擅长回答此类问题
3. **MBTI适配度**（25%权重）：该理论是否适合用户的性格类型

最终选择3-5个最适合的理论进行组合分析。

## 🔍 冲突解决机制 (v3.0 四级系统)

当多个理论出现矛盾时，系统采用智能4级冲突解决策略：

| 冲突级别 | 判断差异 | 解决策略 | 置信度 |
|---------|---------|---------|--------|
| Level 1 | < 0.2 | 完全一致，无需处理 | 100% |
| Level 2 | 0.2-0.4 | 微小差异，简单平均 | 85% |
| Level 3 | 0.4-0.5 | 显著差异，加权调和 | 70% |
| Level 4 | > 0.5 | 严重冲突，深度分析 | 50% |

**冲突解决特性**：
- 判断值量化（大吉=1.0, 吉=0.7, 平=0.5, 凶=0.3, 大凶=0.0）
- 智能权重计算（基于置信度和冲突参与度）
- 冲突理论惩罚机制（Level 4参与者权重×0.7）
- 生成冲突摘要和个性化建议

## 📁 项目结构

```
cyber_mantic/
├── main.py                 # 程序入口
├── config.yaml             # 配置文件
├── requirements.txt        # 依赖清单
├── models.py               # 数据模型
│
├── core/                   # 核心模块
│   ├── decision_engine.py  # 决策引擎
│   ├── theory_selector.py  # 理论选择器
│   └── conflict_resolver.py # 4级冲突解决器 🆕
│
├── theories/               # 术数理论模块
│   ├── base.py             # 基类定义
│   ├── bazi/               # 八字模块（含12种神煞）
│   ├── xiaoliu/            # 小六壬模块
│   ├── meihua/             # 梅花易数模块
│   ├── liuyao/             # 六爻模块
│   ├── qimen/              # 奇门遁甲模块
│   ├── ziwei/              # 紫微斗数模块
│   ├── daliuren/           # 大六壬模块 🆕
│   └── cezi/               # 测字术模块 🆕
│
├── utils/                  # 工具模块 🆕
│   ├── time_utils.py       # 时间工具（真太阳时）
│   ├── lunar_calendar.py   # 农历转换（1900-2100）
│   ├── logger.py           # 日志系统（loguru）
│   ├── config_validator.py # 配置验证
│   └── startup.py          # 启动初始化
│
├── api/                    # API集成
│   ├── manager.py          # 多API管理器（4提供商）🆕
│   └── prompts.py          # Prompt模板
│
└── data/                   # 数据文件
    └── constants/          # 常量数据
```

## 🎁 v3.1 新特性

### 高德地图API集成
- **智能地点查询**：GUI输入出生地点（如"北京市朝阳区"）自动获取经纬度
- **真太阳时支持**：精确经度用于真太阳时计算，提高八字排盘准确性
- **用户友好**：无需手动查找经度，一键查询自动填充
- **可选功能**：未配置API密钥可手动输入经度

### 新增术数理论（8个全部完成！）
- **大六壬**：四课起算、三传提取、十二天将配置、课体判断、吉凶分析
- **测字术**：笔画分析、结构分析、部首分析、五行生克、拆字解读、字义判断

### 起卦时间功能
- `initial_inquiry_time` 字段（区分起卦时间与当前时间）
- 对时间敏感理论（奇门遁甲、六爻、梅花易数）至关重要
- GUI支持自定义起卦时间设置
- 所有Prompt模板更新以包含起卦时间

### GUI界面优化
- **可选输入字段系统**：出生信息、随机数、测字输入、起卦时间均可选
- **动态控件**：根据选择自动启用/禁用相关输入框
- **美化报告显示**：可视化进度条、格式化文本、清晰层次结构
- **更友好体验**：针对不同理论的专用输入提示

## 🎁 v3.0 新特性

### 多API提供商支持
- 支持4个AI提供商（Claude/Gemini/Deepseek/Kimi）
- 智能故障转移（按优先级自动切换）
- 双模型验证（主副模型并发调用交叉验证）
- 完整的日志追踪和性能监控

### 术数理论扩展
- **奇门遁甲**：时间验证、阴阳遁判断、九宫排布、吉凶方位
- **紫微斗数**：命宫身宫计算、十四主星排布、四化星安置
- **八字神煞**：12种重要神煞自动计算与分析

### 基础设施完善
- **农历转换**：精确万年历（1900-2100），支持闰月
- **时间工具**：真太阳时计算、节气自动计算
- **冲突解决**：4级智能冲突解决机制
- **配置验证**：启动时自动验证配置完整性
- **日志系统**：基于loguru的多级日志系统

## 🧪 测试

运行测试：

```bash
pytest tests/
```

## 🤝 贡献

欢迎贡献！请查看贡献指南。

主要可以贡献的方向：

1. **新增术数理论**：实现更多理论模块（奇门遁甲、梅花易数等）
2. **改进算法**：优化排盘算法的准确性
3. **界面开发**：开发PyQt6桌面界面
4. **测试用例**：添加更多测试用例验证准确性

## 📝 许可证

本项目采用 MIT 许可证。

## ⚠️ 免责声明

本系统仅供娱乐和文化研究使用，不构成任何专业建议。预测结果仅供参考，请理性对待。

## 📧 联系方式

- 问题反馈：请提交 Issue
- 功能建议：欢迎 Pull Request

---

**赛博玄数** - 传统智慧与现代科技的融合 🔮✨
