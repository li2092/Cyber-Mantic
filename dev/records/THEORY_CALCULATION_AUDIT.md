# 术数理论计算模块检测报告

**生成时间**: 2026-01-04
**检测范围**: 分析界面 + AI智能对话界面
**重点检测**: 奇门遁甲、大六壬计算完整性

---

## ✅ 更新说明（2026-01-06）

> **重要**: 本文档描述的简化算法问题已于 2026-01-04 通过 V2 版本解决。
>
> **当前状态**:
> - ✅ **奇门遁甲**: 已实现完整版排盘算法 (`calculator_v2.py`)
>   - 精确节气计算、符头确定三元、超神接气法排九宫
>   - 值符值使正确定位、完整格局判断
> - ✅ **大六壬**: 已实现完整版起课算法 (`calculator_v2.py`)
>   - 精确四课排盘、九宗门发用规则（全部9种）
>   - 天将昼夜顺逆配置、完整课体判断
>
> 以下内容为历史审计记录，供参考了解 V1 到 V2 的改进过程。

---

## 📋 一、架构检测结果

### 1.1 分析界面计算模块

**调用链路**:
```
AnalysisTab (UI层)
    ↓
AnalysisService (服务层)
    ↓
DecisionEngine.analyze() (核心引擎)
    ↓
TheoryRegistry.get_theory(name) (理论注册表)
    ↓
theory.calculate(user_input) (统一接口)
```

**特点**:
- ✅ 使用 **TheoryRegistry 统一管理** 所有术数理论
- ✅ 通过基类 `BaseTheory` 定义统一接口
- ✅ 所有8个理论已正确注册：八字、紫微、奇门、六壬、六爻、梅花、小六壬、测字
- ✅ 调用方式规范，易于扩展

### 1.2 AI智能对话界面计算模块

**调用链路**:
```
AIConversationTab (UI层)
    ↓
ConversationService (服务层)
    ↓
直接实例化计算器类:
    - BaZiCalculator()
    - QiMenCalculator()
    - DaLiuRenCalculator()
    - XiaoLiuRenTheory()
    - LiuYaoTheory()
    - MeiHuaTheory()
```

**特点**:
- ⚠️ **直接导入计算器类**，未使用 TheoryRegistry
- ⚠️ 在服务内部实例化计算器
- ✅ 使用的是 **同一套计算器代码**（`theories` 模块）
- ✅ 互不影响（无全局状态共享）

### 1.3 复用 vs 隔离策略

**现状**:
```python
# 分析界面
DecisionEngine → TheoryRegistry → BaseTheory.calculate()

# AI对话界面
ConversationService → Calculator.calculate_xxx() (直接调用)
```

**结论**: ✅ **采用复用策略，无需隔离**

**理由**:
1. **代码复用**: 两个界面使用同一套计算器源码（`theories/qimen/calculator.py` 等）
2. **无状态计算**: 计算器都是无状态的纯函数计算
3. **无全局变量**: 没有共享的全局状态或缓存
4. **线程安全**: 每次调用都是独立的实例或方法调用
5. **易于维护**: 计算逻辑统一，修复bug只需改一处

**建议**: 保持现状，但统一 ConversationService 也通过 TheoryRegistry 调用（可选）

---

## 🔍 二、奇门遁甲计算完整性检测

### 2.1 已实现功能

| 功能模块 | 状态 | 代码位置 | 备注 |
|---------|------|----------|------|
| **时间验证** | ✅ 已实现 | `calculator.py:33-42` | 使用 TimestampValidator |
| **确定阴阳遁** | ✅ 已实现 | `calculator.py:96-98` | 基于节气判断 |
| **计算局数** | ⚠️ 简化实现 | `calculator.py:100-123` | **简化算法** |
| **计算元（上中下）** | ⚠️ 简化实现 | `calculator.py:125-134` | 基于日期模15 |
| **排九宫** | ⚠️ 简化实现 | `calculator.py:136-193` | **仅为示例** |
| **值符值使** | ⚠️ 简化实现 | `calculator.py:195-219` | 简化处理 |
| **用神分析** | ✅ 已实现 | `calculator.py:221-242` | 基于事项类别 |
| **方位分析** | ✅ 已实现 | `calculator.py:244-266` | 吉凶方位判断 |
| **时机建议** | ✅ 已实现 | `calculator.py:268-293` | 时辰建议 |
| **格局分析** | ⚠️ 简化实现 | `calculator.py:295-316` | **简化判断** |
| **综合评分** | ✅ 已实现 | `calculator.py:318-339` | 加权计算 |

### 2.2 简化部分详细分析

#### ❌ **问题1：排九宫逻辑简化**

**现有代码** (`calculator.py:155-193`):
```python
# 简化的排盘逻辑
# 实际奇门遁甲排盘非常复杂，这里只是示例

for i, palace_name in enumerate(NINE_PALACES):
    # 计算九星位置（简化）
    star_index = (ju_number + i) % 9
    star = NINE_STARS[star_index]

    # 计算八门位置（简化）
    door_index = (ju_number + i) % 8
    door = EIGHT_DOORS[door_index]
    # ...
```

**问题**:
- ❌ 未按照正确的超神接气法排盘
- ❌ 九星、八门、八神位置计算不准确
- ❌ 缺少置闰、拆补等特殊处理
- ❌ 天盘、地盘、人盘未严格区分

**影响**:
- AI可能基于错误的九宫排列产生解读，导致幻觉
- 用户反馈与实际排盘结果不符

#### ❌ **问题2：局数计算简化**

**现有代码** (`calculator.py:113-123`):
```python
# 简化处理：根据日期判断上中下元
day_in_term = (date.day - 1) % 15  # 简化计算

if day_in_term < 5:
    yuan_index = 0  # 上元
elif day_in_term < 5:
    yuan_index = 1  # 中元
else:
    yuan_index = 2  # 下元
```

**问题**:
- ❌ 未计算节气后的实际天数
- ❌ 未处理节气交接时刻
- ❌ 超神接气规则未实现

#### ❌ **问题3：值符值使简化**

**现有代码** (`calculator.py:201-219`):
```python
# 简化处理：值符为第一个吉星所在宫位
duty_symbol = None
for palace in palaces:
    if palace["九星"] in ["天辅", "天心", "天禽"]:
        duty_symbol = palace
        break
```

**问题**:
- ❌ 未按照"值符随时干"规则
- ❌ 值使未正确配置

### 2.3 缺失功能

| 功能 | 重要性 | 当前状态 |
|------|--------|----------|
| **超神接气法排盘** | 🔴 关键 | ❌ 缺失 |
| **置闰处理** | 🟡 重要 | ❌ 缺失 |
| **拆补法** | 🟡 重要 | ❌ 缺失 |
| **马星处理** | 🟢 次要 | ❌ 缺失 |
| **空亡处理** | 🟡 重要 | ❌ 缺失 |
| **反吟伏吟判断** | 🟡 重要 | ❌ 缺失 |
| **格局组合判断** | 🟡 重要 | ⚠️ 简化 |

---

## 🔍 三、大六壬计算完整性检测

### 3.1 已实现功能

| 功能模块 | 状态 | 代码位置 | 备注 |
|---------|------|----------|------|
| **日干支计算** | ⚠️ 简化实现 | `calculator.py:71-88` | 简化算法 |
| **时支计算** | ✅ 已实现 | `calculator.py:90-101` | 正确 |
| **月将计算** | ✅ 已实现 | `calculator.py:103-110` | 正确 |
| **起四课** | ⚠️ 简化实现 | `calculator.py:112-161` | **简化逻辑** |
| **取三传** | ⚠️ 简化实现 | `calculator.py:163-187` | **缺发用规则** |
| **配天将** | ⚠️ 简化实现 | `calculator.py:189-221` | 简化顺配 |
| **判断课体** | ⚠️ 简化实现 | `calculator.py:223-256` | **简化判断** |
| **吉凶分析** | ✅ 已实现 | `calculator.py:258-300` | 基本完整 |

### 3.2 简化部分详细分析

#### ❌ **问题1：起四课简化**

**现有代码** (`calculator.py:139-161`):
```python
# 第一课：日干上神
# 简化：以日干配地支
gan_shang_shen_index = (day_gan_index + di_pan_start) % 12
gan_shang_shen = DI_ZHI[gan_shang_shen_index]

# 第二课：干上神之冲
gan_chong = DI_ZHI_CHONG.get(gan_shang_shen, DI_ZHI[(gan_shang_shen_index + 6) % 12])
```

**问题**:
- ❌ 未严格按照"日干支寻地盘"规则
- ❌ 阴阳神判断不准确
- ❌ 月将加时的天盘排列简化

#### ❌ **问题2：取三传缺发用规则**

**现有代码** (`calculator.py:174-186`):
```python
# 简化取法：取四课中的上神作为三传
# 实际大六壬有复杂的发用规则

# 简化：取第1、3、4课的上神作为三传
san_chuan = [
    {"传名": "初传", "地支": shang_shen_list[0]},
    {"传名": "中传", "地支": shang_shen_list[2]},
    {"传名": "末传", "地支": shang_shen_list[3]}
]
```

**问题**:
- ❌ 未实现贼克、比用、涉害等发用规则
- ❌ 未判断返吟、八专、伏吟等特殊课式
- ❌ 三传顺序可能不正确

**大六壬发用口诀** (缺失):
```
一贼二比三涉害  四遥五度六别责
七八九十从革法  昴星发用十二别
```

#### ❌ **问题3：课体判断简化**

**现有代码** (`calculator.py:229-256`):
```python
"""判断课体（简化）"""
# 简化判断：基于三传地支关系
```

**问题**:
- ❌ 未完整实现四课三传课体判断
- ❌ 缺少九宗门、八专课、伏吟课等判断
- ❌ 课体命名可能不准确

### 3.3 缺失功能

| 功能 | 重要性 | 当前状态 |
|------|--------|----------|
| **贼克发用** | 🔴 关键 | ❌ 缺失 |
| **比用发用** | 🔴 关键 | ❌ 缺失 |
| **涉害发用** | 🔴 关键 | ❌ 缺失 |
| **遥克发用** | 🟡 重要 | ❌ 缺失 |
| **昼夜天将顺逆** | 🟡 重要 | ❌ 缺失 |
| **九宗门判断** | 🟡 重要 | ❌ 缺失 |
| **返吟伏吟判断** | 🟡 重要 | ❌ 缺失 |
| **天将六亲关系** | 🟢 次要 | ❌ 缺失 |

---

## 🎯 四、AI幻觉风险评估

### 4.1 当前风险级别

| 理论 | 风险级别 | 主要问题 | 影响 |
|------|---------|---------|------|
| **奇门遁甲** | 🔴 **高风险** | 排盘逻辑简化、局数计算不准 | AI可能基于错误九宫产生解读 |
| **大六壬** | 🔴 **高风险** | 取三传无发用规则、课体判断简化 | 三传顺序错误导致解读偏差 |
| **八字** | 🟢 低风险 | 计算逻辑完整 | ✅ 基础排盘准确 |
| **紫微斗数** | 🟢 低风险 | 排盘基本准确 | ✅ 可信 |
| **六爻** | 🟡 中风险 | 纳甲装卦准确，但卦象解读需AI | ⚠️ 部分依赖AI |
| **梅花易数** | 🟡 中风险 | 起卦准确，解读需AI | ⚠️ 部分依赖AI |

### 4.2 幻觉表现示例

**场景1：奇门遁甲排盘错误**
```
用户：2024年1月5日下午3点起局问事业
系统计算：阳遁三局（可能错误）
AI解读：基于错误的九宫格局进行解读
结果：用户反馈"九星位置不对"
```

**场景2：大六壬三传错误**
```
用户：2024年1月5日问财运
系统计算：三传为子-寅-辰（可能错误）
实际应为：涉害发用，三传应为卯-巳-未
AI解读：基于错误三传解读天将六亲
结果：与专业大六壬软件结果不符
```

---

## 💡 五、补充建议

### 5.1 短期方案（紧急修复）

#### 方案A：添加计算准确性声明

在分析结果中添加提示：

```python
# 在 QiMenTheory.calculate() 返回结果中添加
result["计算说明"] = """
⚠️ 当前奇门遁甲排盘使用简化算法，仅供参考。
九宫排列、值符值使等可能与专业奇门软件存在差异。
建议结合专业排盘软件核对。
"""

# 在 DaLiuRenTheory.calculate() 返回结果中添加
result["计算说明"] = """
⚠️ 当前大六壬起课使用简化发用规则，仅供参考。
三传顺序、课体判断可能与传统大六壬规则有差异。
建议结合专业六壬软件核对。
"""
```

#### 方案B：降低这两个理论的优先级

```python
# 在 theory_selector.py 中调整权重
THEORY_WEIGHTS = {
    "八字": 1.0,
    "紫微斗数": 0.95,
    "奇门遁甲": 0.6,  # 降低优先级（原0.85）
    "大六壬": 0.6,    # 降低优先级（原0.80）
    "六爻": 0.75,
    "梅花易数": 0.70,
    "小六壬": 0.65,
    "测字术": 0.60
}
```

### 5.2 中期方案（逐步完善）

#### 优先级1：完善奇门遁甲排盘

**需实现**:
1. **超神接气法排九宫** (300-400行代码)
   - 实现正确的天盘、地盘、人盘转换
   - 处理置闰、拆补

2. **准确计算局数** (100-150行代码)
   - 基于节气后实际天数
   - 实现上中下元正确划分

3. **值符值使正确配置** (80-100行代码)
   - 值符随时干
   - 值使配八门

**工作量**: 约500-650行代码，需2-3天开发

#### 优先级2：完善大六壬发用

**需实现**:
1. **发用规则** (400-500行代码)
   - 贼克发用
   - 比用发用
   - 涉害发用
   - 遥克、别责等规则

2. **课体准确判断** (200-250行代码)
   - 九宗门
   - 八专课
   - 返吟伏吟

3. **天将昼夜顺逆** (100-150行代码)
   - 判断昼夜
   - 正确顺逆排列

**工作量**: 约700-900行代码，需3-4天开发

### 5.3 长期方案（专业级实现）

#### 选项1：集成专业术数库

考虑集成现有开源术数库（如果存在）：
- 优点：快速获得准确计算
- 缺点：可能无成熟的Python库

#### 选项2：开发专业级计算模块

建立独立的术数计算库：
```
cyber_mantic_calculations/
├── qimen/
│   ├── calendar.py      # 节气历法
│   ├── arrangement.py   # 排盘算法
│   ├── patterns.py      # 格局判断
│   └── tests/           # 单元测试
├── daliuren/
│   ├── fayong.py        # 发用规则
│   ├── keti.py          # 课体判断
│   ├── tianjiang.py     # 天将配置
│   └── tests/
```

**工作量**: 约3000-4000行代码，需2-3周开发

---

## ✅ 六、推荐行动方案

### 立即执行（本次会话）

1. ✅ **添加计算准确性声明** (5分钟)
   - 在奇门遁甲、大六壬结果中添加提示

2. ✅ **调整理论优先级** (5分钟)
   - 降低简化理论的选择权重

3. ✅ **更新文档说明** (10分钟)
   - 在 CLAUDE.md 中标注当前计算限制

### 短期执行（1周内）

4. ⏳ **完善奇门遁甲排盘** (2-3天)
   - 实现超神接气法
   - 准确计算局数

5. ⏳ **完善大六壬发用** (3-4天)
   - 实现贼克、比用、涉害发用
   - 准确判断课体

### 中期规划（1个月内）

6. 📋 **建立单元测试** (5天)
   - 使用标准案例验证排盘准确性
   - 对比专业软件结果

7. 📋 **开发计算器验证工具** (3天)
   - 提供UI界面对比计算结果
   - 方便调试和验证

---

## 📊 七、总结

### 关键发现

1. ✅ **架构合理**: 两个界面复用同一套计算器，无需隔离
2. ⚠️ **计算简化**: 奇门遁甲、大六壬存在明显简化
3. 🔴 **幻觉风险**: AI基于不准确排盘产生解读，降低可信度
4. 💡 **解决方案**: 短期添加声明，中期完善算法

### 优先级建议

| 任务 | 优先级 | 工作量 | 效果 |
|------|--------|--------|------|
| 添加计算声明 | 🔴 P0 | 5min | 立即降低用户期望 |
| 调整理论权重 | 🔴 P0 | 5min | 减少错误结果影响 |
| 完善奇门排盘 | 🟡 P1 | 2-3天 | 显著提升准确性 |
| 完善大六壬发用 | 🟡 P1 | 3-4天 | 显著提升准确性 |
| 建立单元测试 | 🟢 P2 | 5天 | 保障长期质量 |

### 下一步行动

1. **立即**: 执行P0任务（添加声明、调整权重）
2. **本周**: 启动P1任务（完善计算算法）
3. **下月**: 执行P2任务（建立测试体系）

---

**报告生成**: 2026-01-04
**审核状态**: ✅ 已完成
**建议执行**: 🔴 立即实施短期方案
