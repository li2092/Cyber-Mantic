# 赛博玄数 (Cyber-Mantic) - 项目指南

> 基于多理论融合的AI驱动智能命理分析系统

---

## 📌 关于作者（大魔王）

- **背景**: 非技术人员，无编程背景
- **爱好**: 中国传统文化、心理学、社会学爱好者
- **协作要求**: 每次回复请说中文
- **开发方式**: 以客户视角提出功能实现或抽象概念，AI辅助技术落地

---

## 🎯 产品核心理念

### 核心特点

- **智能理论选择**: 根据用户信息，智能选择3-5个最合适的术数理论进行分析
- **冲突仲裁**: 解决理论间的冲突矛盾，给出综合结论
- **个性化报告**: 结合MBTI特点生成个性化分析报告
- **隐私保护**: 最小信息输入原则，保护用户隐私

### 术数理论体系（8大理论）

| 理论 | 代码位置 | 用途 |
|-----|---------|------|
| 八字 | `theories/bazi/` | 命运格局、五行分析 |
| 紫微斗数 | `theories/ziwei/` | 性格、婚姻、事业 |
| 奇门遁甲 | `theories/qimen/` | 择时、决策 |
| 大六壬 | `theories/liuren/` | 事件预测 |
| 六爻 | `theories/liuyao/` | 具体事项占卜 |
| 梅花易数 | `theories/meihua/` | 快速占断 |
| 小六壬 | `theories/xiaoliu/` | 简易占断 |
| 测字术 | `theories/cezi/` | 汉字卦象解析 |

### 功能模块

```
赛博玄数
├── 问道 (Wendao)           # 对话式预测（AI对话提取信息 → 推演）
├── 推演 (Tuiyan)           # 直接输入式预测（表单输入 → 推演）
├── 典籍 (Dianji)           # 阅读模块（术数知识库）
├── 洞察 (Dongcha)          # 用户画像（使用情况统计）
├── 历史 (Lishi)            # 历史记录（存储预测记录）
└── 设置 (Shezhi)           # 系统设置（主题、API接口）
```

---

## 🛠️ 开发哲学：三文件模式

### 核心思想

> 把Markdown文件当作AI的硬盘记忆，强制AI遵循"三文件模式"

与传统开发不同，本项目采用"**渐进式技术落地**"模式：
1. 作者提出功能需求或抽象概念（非技术语言）
2. AI通过三文件模式记录、规划、实现
3. 逐步将概念转化为可运行的代码

### 三文件结构

```
docs/
├── [功能名]_task_plan.md    # 📋 任务规划书
├── [功能名]_notes.md        # 📝 笔记/草稿
└── [功能名]_[交付物名].md   # 📦 交付物文档
```

#### 1️⃣ task_plan.md（任务规划书）

**必须包含**:
- ✅ **目标**: 明确本次任务要达成什么
- 📊 **当前状态**: 已完成/进行中/待处理的问题清单
- 🎯 **阶段规划**: P0/P1/P2优先级划分
- 📁 **关键文件清单**: 涉及的代码文件路径
- 🐛 **错误日志**: 已解决和待解决的问题
- ⏭️ **下一步行动**: 具体可执行的任务

**示例**: `wendao_task_plan.md`

#### 2️⃣ notes.md（笔记/草稿）

**必须包含**:
- 🏗️ **架构理解**: 数据流、模块关系
- 🔧 **技术细节**: 关键代码片段、实现方案
- ✅ **已修复问题详解**: 问题原因和解决方案
- 🔍 **待探索方向**: 优化点、潜在问题
- 🧪 **测试用例**: 正常流程和异常流程

**示例**: `wendao_notes.md`

#### 3️⃣ [deliverable].md（交付物）

**必须包含**:
- 📖 **功能概述**: 做什么、为什么
- 🔄 **交互流程**: 用户视角的操作流程
- 🎨 **详细设计**: 各模块/阶段的输入输出
- 📐 **UI/API规格**: 组件尺寸、接口格式
- ⚠️ **异常处理**: 边界情况的处理策略
- 🚀 **后续规划**: 短期/中期/长期路线图

**示例**: `wendao_enhancement.md`

### 工作流循环

```
┌──────────┐
│ 1. 读计划 │ ← 了解当前状态和目标
└────┬─────┘
     ↓
┌────┴─────┐
│ 2. 行动  │ ← 编码、修复、测试
└────┬─────┘
     ↓
┌────┴─────┐
│ 3. 记录  │ ← 更新三文件（尤其是问题和进度）
└────┬─────┘
     ↓
┌────┴─────┐
│ 4. 复盘  │ ← 检查目标是否达成，规划下一步
└────┬─────┘
     ↓
    回到步骤1
```

### 关键原则

> **"我是没有记忆的，所有要点都要用文件记下来、保存下来"**

- 📝 好记性不如烂笔头
- 🔗 特别要记录设计理念和系统相互的联系
- 🔄 不要改一个忘一个
- 📂 文档是AI的"外部记忆"

### 现有三文件清单

| 功能 | 任务规划 | 笔记 | 交付物 | 状态 |
|------|----------|------|--------|------|
| **问道界面** | `wendao_task_plan.md` | `wendao_notes.md` | `wendao_enhancement.md` | 🟢 P0/P1完成，P2优化中 |
| **问道流程设计** | `wendao_flow_task_plan.md` | `wendao_flow_notes.md` | `wendao_flow_design.md` | ✅ 设计完成，已落地 |
| **V2版本** | `v2_task_plan.md` | `v2_notes.md` | `v2_implementation.md` | ✅ 核心功能已完成 |
| **产品重构** | - | - | `PRODUCT_REDESIGN_PRD.md` | 🟡 PRD完成 |
| **技术架构** | - | - | `TECHNICAL_ARCHITECTURE_DESIGN.md` | 🟡 架构设计完成 |

**补充文档**:
- `v2_frontend_gap_analysis.md` - V2前端差异分析报告
- `BUGFIX_*.md` - 各种Bug修复记录

---

## 🏗️ 技术架构概览

### 当前版本 (v1.x - PyQt6桌面应用)

```
技术栈:
- Python 3.11+
- PyQt6 (桌面UI)
- Claude/DeepSeek/Kimi (AI服务)
- SQLite (本地存储)

核心模块:
├── core/                    # 核心引擎
│   ├── conversation/        # 5阶段问道对话引擎
│   ├── theories/            # 8大理论模块
│   ├── arbitration_system.py  # 冲突仲裁系统
│   ├── flow_guard.py        # FlowGuard验证
│   └── ai_orchestration.py  # AI服务编排
├── services/                # 业务服务
├── ui/                      # PyQt6界面
│   ├── components/          # 组件 (Sidebar, NavItem)
│   ├── widgets/             # 控件 (ChatWidget, ResultCard)
│   └── design_system.py     # 设计系统
└── prompts/                 # AI提示词模板
```

### 未来版本 (v2.x - 跨平台)

**目标**: 桌面端 + 移动端 + Web端 + 微信小程序

**技术栈**:
- 后端: FastAPI + PostgreSQL + Redis
- Web: Next.js + React
- Mobile: Flutter
- 小程序: Taro

详见: `docs/TECHNICAL_ARCHITECTURE_DESIGN.md`

---

## 🔑 核心系统详解

### 1. 问道对话引擎 (5阶段流程)

```python
# 路径: services/conversation/stage_handlers.py

阶段1: Welcome（欢迎）
    ↓ 检测用户回复有效性
阶段2: Icebreaker（破冰）
    ↓ 建立信任，初步了解问题
阶段3: Deep Talk（深入对话）
    ↓ 探索问题本质
阶段4: Info Collection（信息采集）
    ↓ 提取八字信息（姓名、生辰、性别等）
阶段5: Verification（验证）
    ↓ 确认信息准确性
生成报告: Report
    ↓ 多理论推演 + 冲突仲裁
```

**关键实现**:
- `stage_handlers.py` - 阶段转换逻辑
- `nlp_parser.py` - NLP信息提取
- `report_generator.py` - 报告生成

### 2. AI服务编排系统

```python
# 路径: core/ai_orchestration.py

智能路由策略:
┌─────────────────────────────────────┐
│ 任务类型      → 选择AI              │
├─────────────────────────────────────┤
│ 对话 (conversation) → Claude (主力) │
│ 理论分析 (theory)   → Claude (主力) │
│ 长文本 (long_text)  → Kimi          │
│ 快速任务 (quick)    → DeepSeek      │
└─────────────────────────────────────┘

降级策略:
Claude失败 → DeepSeek → Kimi → 全部失败抛出异常
```

### 3. 冲突仲裁系统

```python
# 路径: core/arbitration_system.py

流程:
1. 检测冲突 (detect_conflicts)
   - 直接矛盾 (contradiction)
   - 模糊性 (ambiguity)
   - 低置信度 (low_confidence)

2. AI仲裁 (resolve_conflicts)
   - 分析各理论论据强度
   - 综合用户实际情况
   - 给出最终结论

3. 置信度评分
   - 0-1分值
   - 反映综合可信度
```

### 4. FlowGuard验证系统

```python
# 路径: core/flow_guard.py

双重验证:
┌────────────┐     ┌──────────────┐
│ AI验证      │     │ 代码验证     │
│ (合理性评估)│ +   │ (硬编码规则)  │
└────────────┘     └──────────────┘
       ↓                  ↓
     结合判断，确保推演质量

时间轴分析:
- 记录每个关键步骤
- 可视化推演过程
- 可追溯可审计
```

## 💡 开发提示（给AI）

### 核心原则

1. **记忆外置化**: 所有重要信息必须写入Markdown文件
2. **三文件模式**: task_plan.md + notes.md + deliverable.md
3. **渐进式开发**: 从抽象概念逐步技术落地
4. **用户视角**: 使用中文，以非技术语言解释技术概念

### 工作流程

```
收到需求 → 查阅task_plan.md → 理解当前状态 →
编码实现 → 更新notes.md → 更新task_plan.md →
测试验证 → 更新deliverable.md → 复盘
```

### 关键文件必读

**开始新任务前**:
1. 读取对应的 `*_task_plan.md` 了解目标和状态
2. 读取 `*_notes.md` 了解技术细节
3. 读取相关代码文件（从task_plan中的文件清单）

**完成任务后**:
1. 更新 `*_task_plan.md` 的进度和下一步
2. 在 `*_notes.md` 中记录技术细节和已解决问题
3. 更新 `*_deliverable.md` 反映最新状态

### 特殊要求

- ✅ 称呼用户为"**大魔王**"
- ✅ 使用中文交流
- ✅ 非技术术语解释技术概念
- ✅ 保持友好、耐心的态度

---

> 💡 **给AI的提示**: 本项目采用"三文件模式"开发，所有要点都记录在Markdown文件中。开始工作前，务必查阅 `docs/*_task_plan.md` 了解当前状态。技术架构详见 `docs/TECHNICAL_ARCHITECTURE_DESIGN.md`。

> 🎯 **给开发者的提示**: 这是一个非技术背景用户主导的项目，强调概念到代码的渐进式转化。文档是理解项目的关键，特别是三文件模式下的各类文档。
