# 更新日志

## v3.6 - 2024-12-31

### 🤖 AI智能化优化 - 让AI做AI擅长的事

#### 核心理念转变
不再使用硬编码规则处理需要智能判断的任务，改为后台调用Kimi让AI智能处理。

#### 新增核心模块

##### 1. AI智能助手 (`core/ai_assistant.py`) 🤖
**后台调用Kimi完成智能任务，用户无感知**

- **智能摘要生成** ✨
  - ❌ 旧方式：硬编码查找"## 一、执行摘要"，提取固定格式
  - ✅ 新方式：将完整报告发给Kimi，智能生成200-300字核心摘要
  - 优势：不依赖格式，智能提炼要点，自动过滤冗余

- **智能行动建议生成** 🎯
  - ❌ 旧方式：返回硬编码的空洞建议"根据分析结果采取行动"
  - ✅ 新方式：Kimi根据分析结果生成3-5条具体可执行的建议
  - 优势：建议具体可行，自动分配优先级（高/中/低）

- **术语智能解释** 📖
  - 用户遇到不懂的术语，AI实时解释

- **用户问题智能解答** 💬
  - 基于报告内容，AI回答用户疑问

- **报告可读性优化** 📝
  - 过长报告自动压缩优化，保留核心信息

- **历史报告对比洞察** 📊
  - AI生成趋势分析和变化洞察

##### 2. 简化版主题系统 (`ui/themes_simplified.py`) 🎨
**采纳用户建议：去掉MBTI个性化配色和吉凶配色**

- **三大基础主题**
  - 清雅白：简洁明亮，适合白天
  - 墨夜黑：护眼深色，适合夜间
  - 禅意灰：平静沉稳，适合长时间阅读

- **现代化设计**
  - 渐变效果
  - 圆角设计（8px/6px/4px）
  - 阴影系统
  - 统一配色，简洁专业

##### 3. 增强版报告渲染器 (`ui/report_renderer_enhanced.py`) 📊
**专注于充实基础内容，提升专业性**

- **完整的信息呈现**
  - 基本信息表格
  - 理论共识度分析
  - 数据可视化（星级、进度条、柱状图）

- **清晰的结构组织**
  - 执行摘要（使用AI智能生成）
  - 各理论详细分析
  - 行动建议（使用AI智能生成）
  - 冲突分析
  - 免责声明和使用说明

- **取消个性化**
  - 去掉MBTI个性化呈现
  - 去掉吉凶配色
  - 统一风格，专注专业性

##### 4. PDF导出功能 (`utils/pdf_exporter.py`) 📄
**使用reportlab生成专业PDF报告**

- 精美标题和基本信息表格
- 执行摘要（AI智能生成）
- 各理论详细分析（卡片布局）
- 行动建议（AI智能生成）
- 局限性说明和免责声明
- 中文字体支持

#### 核心改进

##### Decision Engine集成AI助手
**修改 `core/decision_engine.py`**

```python
# 新增步骤：AI智能助手处理
- 步骤5-1: Kimi智能生成执行摘要（90%进度）
- 步骤5-2: Kimi智能生成行动建议（95%进度）
```

##### 工作流程优化
```
用户提问 → 理论选择 → 理论计算 → Claude详细分析
    ↓
Claude生成综合报告
    ↓
========== AI智能助手介入 ==========
    ↓
Kimi智能生成摘要（200-300字核心内容）
    ↓
Kimi智能生成建议（3-5条具体可执行建议）
    ↓
========== 报告渲染 ==========
    ↓
精美呈现给用户
```

#### 完整文档

- **📖 AI集成指南** (`docs/AI_INTEGRATION_GUIDE.md`)
  - 核心理念：让AI做AI擅长的事
  - 6大智能化功能详解
  - 简化版主题系统使用
  - 增强版渲染器使用
  - PDF导出功能使用
  - 完整集成步骤（5步）
  - 系统工作流程图
  - 关键决策和原因
  - 性能优化说明
  - 未来扩展方向
  - 常见问题解答

#### 核心优势

1. **智能化** 🤖
   - AI生成摘要，质量高且灵活
   - AI生成建议，具体可行
   - 后台智能处理，用户无感知
   - 每个功能都有降级方案

2. **简洁化** ✨
   - 三大主题，简单易用
   - 去掉复杂配色，专注专业性
   - 统一风格，清爽优雅

3. **专业化** 📊
   - PDF导出，正式报告
   - 充实内容，信息完整
   - 数据可视化，直观易懂

4. **可靠性** 🛡️
   - 降级方案，确保稳定
   - 异步处理，不阻塞
   - 错误处理，友好提示

#### 预期效果
- 用户满意度提升：+50%（预估）
- 摘要质量：从硬编码提取→AI智能生成
- 建议实用性：从空洞套话→具体可执行
- 视觉专业性：从单调文本→精美报告

#### 实施状态
- ✅ 核心模块开发完成
- ✅ AI助手集成完成
- ✅ 完整文档编写完成
- ⏳ 等待集成到主窗口（5步即可完成）
- ⏳ PDF导出测试

---

## v3.5 - 2024-12-31

### 🎨 分析报告优化方案（待集成）

#### 新增模块
- **🎨 主题系统** (`ui/themes.py`)
  - 三大基础主题：清雅白、墨夜黑、禅意灰
  - 16种MBTI个性化配色方案
  - 吉凶判断专属配色系统
  - 自动生成QSS样式表
  - 支持渐变、圆角、阴影等现代化设计元素

- **📊 智能报告渲染器** (`ui/report_renderer.py`)
  - MBTI个性化呈现（4大类型组别）
    * NT类型：逻辑结构化，数据分析视图
    * NF类型：叙事性结构，深层洞察
    * SJ类型：传统规范，详细信息分解
    * SP类型：要点式，行动清单
  - 执行摘要精美渲染
  - 理论详情卡片化呈现
  - 冲突分析可视化
  - 数据可视化（柱状图、星级、进度条）

#### 完整文档
- **📖 优化方案指南** (`docs/REPORT_OPTIMIZATION_GUIDE.md`)
  - GUI界面精美化方案
  - 报告内容专业化方案
  - MBTI个性化呈现方案
  - 交互体验优化方案
  - 5个阶段的实施步骤
  - 效果预览和对比

- **💻 集成示例代码** (`docs/INTEGRATION_EXAMPLE.md`)
  - 快速集成指南（4个步骤）
  - 完整代码示例
  - 最小化集成方案
  - 效果对比预览
  - 常见问题解答

#### 核心特性
1. **多主题支持** ✨
   - 用户可根据使用场景选择主题
   - 支持MBTI个性化强调色
   - 一键切换，实时生效

2. **个性化呈现** 🎯
   - NT用户看到量化分析和数据统计
   - NF用户看到深层洞察和哲学思考
   - SJ用户看到详细信息表格
   - SP用户看到行动要点清单

3. **专业视觉** 📊
   - 精美卡片布局
   - 渐变背景和边框
   - 吉凶判断颜色编码
   - 星级评分可视化
   - 置信度进度条

4. **易于扩展** 🔧
   - 模块化设计
   - 与核心逻辑解耦
   - 添加新主题只需配置
   - 自定义渲染易于继承

#### 预期效果
- 用户满意度提升：+40%（预估）
- 视觉吸引力：从单调文本到精美报告
- 个性化体验：每个MBTI类型都有专属呈现
- 专业性提升：数据可视化，直观易懂

#### 实施状态
- ✅ 核心模块开发完成
- ✅ 文档编写完成
- ⏳ 等待集成到主窗口
- ⏳ 用户测试和反馈

---

## v3.4 - 2024-12-31

### 🐛 BUG修复

#### P0 严重BUG修复
- **🔧 修复测字术birth_time属性错误**（theories/cezi/theory.py:109-134）
  - 问题：代码使用了不存在的 `user_input.birth_time` 属性，导致AttributeError
  - 修复：改用 `user_input.birth_hour` 字段
  - 优化：消除了重复的时辰地支映射代码
  - 影响：测字术在回退到时辰起卦时不再崩溃

- **📊 修复报告解析逻辑与灵活提示词不兼容问题**（core/decision_engine.py:328-355）
  - 问题：提取逻辑仍在查找旧版固定格式"## 一、执行摘要"，但新提示词已改为灵活格式
  - 修复：
    - `_extract_summary()`: 返回完整报告文本，由UI层处理格式化
    - `_extract_section()`: 返回空字符串，章节内容已包含在主报告中
    - `_extract_advice()`: 移除硬编码的虚假建议，返回空列表
  - 影响：用户现在能看到完整的AI生成报告，不再被固定格式限制

#### P1 高优先级修复
- **✅ 增强输入验证逻辑**（ui/main_window.py:554-581）
  - 问题：验证在创建UserInput对象之后，且只验证问题描述
  - 改进：
    - 将验证移到对象创建之前
    - 新增出生信息完整性验证（如果勾选了"提供出生信息"）
    - 新增友好提示：如果没提供任何额外信息，询问用户是否继续
  - 影响：更清晰的用户提示，避免创建无效的UserInput对象

- **🛡️ 增强错误处理**（core/decision_engine.py:136-142）
  - 问题：如果所有理论分析都失败，没有明确错误提示
  - 改进：在理论分析循环后检查结果列表，如果为空则抛出清晰的异常
  - 影响：用户能收到明确的错误信息，而不是神秘的后续错误

### 🔧 代码质量改进

#### P2 中优先级优化
- **🗑️ 清理废弃代码**（core/decision_engine.py:235-247）
  - 删除了从未被调用的 `_detect_conflicts()` 方法
  - 该方法标记为"已废弃"但一直保留在代码中
  - 减少维护负担，提高代码可读性

- **📝 改进日志记录**
  - 在理论分析失败时添加logger.error记录
  - 成功分析后记录成功理论数量
  - 便于调试和问题追踪

### 📋 已识别但未修复的问题（待后续处理）

#### 代码一致性问题
- **理论接口不统一**：CeZiTheory和DaLiuRenTheory有 `get_category()` 方法，但BaseTheory未定义此抽象方法
- **建议**：要么在BaseTheory添加抽象方法，要么删除现有实现

#### 性能优化机会
- **理论计算可并行化**：当前顺序执行各理论计算，可改为asyncio并行执行
- **预期收益**：总分析时间从累加变为最大值，显著缩短等待时间

---

## v3.3 - 2024-12-31

### 🎉 新增功能

#### 时辰确定性处理系统 ✨新增
- **⏰ 三级时辰确定性选择**
  - **记得时辰**：使用精确时间，所有理论正常分析
  - **大概是这个时辰**：进行多时辰对比分析（前后时辰对比）
  - **不记得时辰**：只使用不依赖时辰的理论（梅花易数、小六壬、六爻、测字术、奇门遁甲、大六壬）

- **📊 智能理论选择调整**
  - 新增 `birth_time_certainty` 字段（UserInput模型）
  - 根据时辰确定性自动调整理论权重
    - 不记得时辰：八字/紫微斗数权重降至30%（简化分析）
    - 大概是这个时辰：八字/紫微斗数权重降至80%（需要对比分析）
  - 优先选择不依赖时辰的理论

- **🎯 差异化分析策略**
  - **记得时辰**：完整四柱八字，精确命宫定位
  - **大概是这个时辰**：
    - 分析前后一个时辰（共3个时辰）
    - 标注关键差异（时柱、命宫变化）
    - 给出条件性建议
  - **不记得时辰**：
    - 八字：只分析年月日三柱
    - 紫微斗数：提示需要时辰才能排盘
    - 其他理论正常使用

- **💬 Prompt模板增强**
  - 添加时辰确定性信息到所有分析模板
  - AI自动根据时辰确定性调整解读方式
  - 提示用户时辰不确定可能导致的准确性影响

- **🖥️ GUI交互优化**
  - 新增"时辰确定性"下拉选择框
  - 根据选择动态启用/禁用时分输入框
  - 友好的用户提示说明

#### MBTI性格类型集成
- **🧠 MBTI性格分析模块**
  - 新增 `utils/mbti_analyzer.py` 完整MBTI分析系统（~300行）
  - 16种MBTI类型完整数据（Analysts, Diplomats, Sentinels, Explorers）
  - 每种类型包含：中文名称、核心特质、优势、弱点、决策风格
  - 基于MBTI+问题类型的个性化建议生成
  - 针对不同问题类别（事业/财运/感情/健康/择时）的定制化建议

- **🎨 GUI界面增强**
  - 出生信息区新增MBTI类型选择下拉框
  - 17个选项：默认"请选择" + 16种MBTI类型（含中文名）
  - 与出生信息联动启用/禁用
  - 自动提取MBTI类型并传递到分析流程

- **📝 Prompt模板升级**
  - `SINGLE_THEORY_INTERPRETATION` 新增MBTI字段
  - `COMPREHENSIVE_REPORT` 增强MBTI使用指导
  - 详细的MBTI维度建议（T/F, J/P, I/E）
  - 强调根据性格特点调整表述方式

- **⚙️ 决策引擎集成**
  - 单理论解读自动包含MBTI信息
  - 综合报告自动生成MBTI性格分析章节
  - 基于MBTIAnalyzer的个性化建议生成
  - MBTI+问题类型的双维度智能匹配

#### MBTI类型支持
- **分析师组（NT）**: INTJ-建筑师, INTP-逻辑学家, ENTJ-指挥官, ENTP-辩论家
- **外交官组（NF）**: INFJ-提倡者, INFP-调停者, ENFJ-主人公, ENFP-竞选者
- **守护者组（SJ）**: ISTJ-物流师, ISFJ-守卫者, ESTJ-总经理, ESFJ-执政官
- **探险家组（SP）**: ISTP-鉴赏家, ISFP-探险家, ESTP-企业家, ESFP-表演者

#### 个性化建议示例
- **思考型(T)** → 强调逻辑分析、利弊权衡
- **情感型(F)** → 关注价值观、人际影响
- **判断型(J)** → 提供清晰计划、时间表
- **知觉型(P)** → 保持灵活性、多种方案
- **内向型(I)** → 建议独立思考、深度分析
- **外向型(E)** → 建议社交互动、团队协作

#### 文件变更
- 新增文件：1个
  - `utils/mbti_analyzer.py` - MBTI分析器（~304行）
- 修改文件：5个
  - `models.py` - 添加 `birth_time_certainty` 字段（+1行）
  - `ui/main_window.py` - 添加时辰确定性选择+MBTI控件（+50行）
  - `api/prompts.py` - 增强时辰确定性+MBTI提示词（+30行）
  - `core/theory_selector.py` - 根据时辰确定性调整理论权重（+10行）
  - `core/decision_engine.py` - 集成时辰确定性+MBTI分析（+20行）

#### 技术改进
- ✅ 时辰确定性三级分类系统
- ✅ 智能理论选择算法（根据时辰确定性）
- ✅ 差异化分析策略（记得/大概/不记得）
- ✅ GUI动态控制时分输入框
- ✅ Prompt模板智能引导AI处理时辰不确定
- ✅ MBTI数据模型完整定义（16类型 × 4维度）
- ✅ GUI组件与数据模型无缝集成
- ✅ 决策引擎自动生成性格化建议
- ✅ 支持MBTI类型验证

### 体验优化

- ✨ **Prompt模板灵活化改造** - 告别固定格式，拥抱个性化 🔥
  - **移除固定报告格式**：不再要求"一、二、三"的死板结构
  - **问题导向**：AI根据问题性质（事业/感情/健康等）自由组织内容
  - **MBTI深度个性化**：
    - **语言风格个性化**：NT类型用逻辑分析语言，NF类型用温暖洞察语言，SJ类型用务实具体语言，SP类型用简洁直接语言
    - **报告结构个性化**：NT喜欢图表化逻辑结构，NF喜欢故事性叙述，SJ喜欢规范编号，SP喜欢简洁要点
    - **建议方式个性化**：T强调利弊分析，F强调价值观，J提供清晰计划，P提供灵活选项
  - **灵活应变**：AI可以根据理论共识/分歧、问题复杂度等自主调整报告呈现
  - **适用范围**：单理论解读和综合报告均采用灵活模板

- ✨ **系统提示词全面优化** - 增强AI解读专业性和用户体验
  - 新增身份定位：学贯古今的术数专家+现代心理学素养
  - 新增4大核心原则：数据信任、多理论融合、实用导向、概率思维
  - 新增5维解读风格指导：
    1. 专业而不晦涩（术语配通俗解释）
    2. 温和而不迎合（如实告知+化解建议）
    3. 具体而不空泛（给出方位/特征等细节）
    4. 留有余地（概率性表达）
    5. 尊重用户（使用「您」、肯定选择权）
  - 避免恐吓式预测，提供化解方案
  - 使用敬语，承认预测的或然性

### Bug 修复
- 🐛 **修复测字术输入验证**：现在必须提供字才会调用测字术，避免错误分析
- 🐛 **修复进度条显示**：从0%直跳100%改为实时平滑更新（5%-10%-70%-85%-100%）
- 🐛 **修复报告呈现格式**：从显示Markdown源码改为正确渲染格式化文本
- 🐛 **优化摘要内容**：自动提取核心内容，超长自动截断，不再没头没尾
- 🐛 修复模型配置版本过时问题（更新至最新版本）
- 🐛 优化Deepseek Reasoner模型提示词（增强深度思考引导）
- 🐛 修复设置页面缺少高德地图API和双模型验证配置

---

## v3.2 - 2024-12-31

### 🎉 重大更新：GUI 增强与配置系统重构

#### 核心功能
- **🔧 配置管理系统**
  - 新增 `utils/config_manager.py` 统一配置管理
  - 支持多层配置：系统配置 + 环境变量 + 用户配置
  - 自动加载 .env 文件（解决之前无法读取 .env 的问题）
  - 智能环境变量替换（`${CLAUDE_API_KEY}` 格式）
  - 配置优先级：用户配置 > 环境变量 > 系统配置
  - 用户配置保存到 `user_config.yaml`（对小白更友好）

- **📜 历史记录系统**
  - 新增 `utils/history_manager.py` 历史记录管理
  - SQLite 数据库存储（`data/user/history.db`）
  - 完整保存分析报告（JSON格式）
  - 支持按时间、类型、关键词搜索
  - 统计信息展示
  - 一键查看/删除历史记录

- **🎨 GUI 重构为标签页架构**
  - **📊 分析标签页**：保留原有全部功能
  - **⚙️ 设置标签页**：全新功能
    - 直接在 GUI 中配置 4 个 AI API 密钥
    - 密码字段隐藏/显示切换（眼睛按钮）
    - 选择优先使用的 API
    - 一键保存配置到 `user_config.yaml`
    - 实时配置验证（至少一个 API Key）
    - 详细的帮助说明（API 获取地址）
  - **📜 历史记录标签页**：全新功能
    - 表格展示所有历史分析
    - 实时搜索（问题描述关键词）
    - 类型筛选（事业/财运/感情等）
    - 查看历史报告（一键切换到分析标签页）
    - 删除历史记录（带确认提示）
    - 统计信息（总数、最近分析时间）

#### 用户体验改进
- ✅ **解决 .env 读取问题**：现在 GUI 启动时自动加载环境变量
- ✅ **小白友好**：无需手动编辑 .env 文件，直接在 GUI 设置
- ✅ **配置持久化**：GUI 设置自动保存，下次启动自动加载
- ✅ **历史查询**：再也不会丢失之前的分析结果
- ✅ **启动检查**：检测到未配置 API 时自动提示跳转到设置

#### 技术架构
- 配置管理器（ConfigManager）：
  - 深度合并配置字典
  - 递归替换环境变量
  - 点号路径访问（`config.get("api.claude_api_key")`）
  - 全局单例模式
- 历史管理器（HistoryManager）：
  - SQLite ORM 封装
  - 自动建表建索引
  - ComprehensiveReport ↔ Dict 双向转换
  - 异常安全的数据库操作
- GUI 架构：
  - 主标签页（QTabWidget）
  - 模块化设计（每个标签页独立创建）
  - 自动刷新机制（分析完成自动刷新历史）

### 文件变更
- 新增文件：2个
  - `utils/config_manager.py` - 配置管理器（~270行）
  - `utils/history_manager.py` - 历史记录管理器（~330行）
- 修改文件：1个
  - `ui/main_window.py` - 完全重构（687行 → 992行）
    - 新增设置标签页（~190行）
    - 新增历史记录标签页（~180行）
    - 集成配置管理器和历史管理器

### Bug 修复
- 🐛 修复 .env 文件在 GUI 中无法读取的问题
- 🐛 修复配置更新后需要重启的问题（现在实时重载）
- 🐛 修复中文引号导致的语法错误（3处）
- 🐛 修复 report.timestamp 属性不存在错误
- 🐛 修复大六壬和测字术抽象方法缺失

## v3.1 - 2024-12-31

### 🎉 新增功能

#### 高德地图API集成 ✨新增
- **智能地点查询**：GUI界面新增出生地点输入功能
  - 输入地址（如"北京市朝阳区"）自动查询经纬度
  - 一键查询按钮，后台异步调用高德地图API
  - 查询成功后自动填充经度字段
  - 支持真太阳时计算的地理位置准确性
- **用户友好设计**：
  - 无需手动查找经度数据
  - 显示完整地址信息确认
  - 错误提示友好（网络、API密钥、地址未找到等）
  - 可选功能，未配置API密钥可手动输入经度

#### 新增术数理论
- ✅ **大六壬模块** - 完整的大六壬排课系统
  - 四课起算（第一课至第四课）
  - 三传提取（初传、中传、末传）
  - 十二天将配置（贵人、腾蛇、朱雀等）
  - 课体判断（顺连茹、逆连茹、涉害等）
  - 吉凶分析（基于天将属性和课体）
  - 日干支精确计算
  - 月将计算（正月登明在亥）

- ✅ **测字术模块** - 完整的测字分析系统
  - 笔画数分析（81数理）
  - 字体结构分析（左右、上下、包围等）
  - 部首分析（吉凶属性、五行归属）
  - 五行生克分析（笔画五行 vs 部首五行）
  - 拆字分析（观形、取象等方法）
  - 字义吉凶判断
  - 智能字符提取（从问题描述中自动提取）

现在系统支持**8个术数理论**：
1. 八字（命理类 - 基础）
2. 小六壬（快速类）
3. 梅花易数（快速类）
4. 六爻（占卜类 - 深度）
5. 奇门遁甲（深度类 - 择时）
6. 紫微斗数（命理类 - 基础）
7. **大六壬（占卜类 - 深度）** ✨新增
8. **测字术（占卜类 - 快速）** ✨新增

#### 功能改进

**起卦时间功能** ✨新增
- `initial_inquiry_time` 字段（用户首次咨询时间）
- 区分起卦时间与当前时间
- 对于时间敏感的理论（如奇门遁甲、六爻）至关重要
- GUI支持自定义起卦时间设置
- 所有API Prompt模板更新以包含起卦时间

**GUI界面优化** ✨新增
- 可选输入字段系统：
  * 出生信息（用于八字、紫微斗数）- 可选
    - 出生年月日时分（精确到分钟）
    - 历法类型选择（阳历/农历）
    - 性别选择（男/女）
    - 出生地经度（用于真太阳时计算）
  * 随机数（用于梅花易数、六爻）- 可选
  * 测字输入（用于测字术）- 可选
  * 起卦时间（自定义或使用当前时间）- 可选
- 动态启用/禁用控件（根据checkbox自动控制）
- 完整的UserInput字段支持（100%覆盖models.py定义）
- 改进的报告显示格式：
  * 美化的标题和分隔符
  * 可视化进度条（判断程度、置信度）
  * 格式化解读文本
  * 更清晰的层次结构
- 更友好的用户提示
- 测字字符正确传递到UserInput.character字段

#### 技术改进
- ✅ 大六壬起课算法实现（简化版，实用导向）
- ✅ 测字术字形分析（基于部首和结构）
- ✅ 五行生克关系扩展应用
- ✅ GUI组件模块化（checkboxes + 动态控制）
- ✅ 起卦时间贯穿整个分析流程
- ✅ 用户输入模型扩展（支持 initial_inquiry_time）
- ✅ Prompt模板统一更新
- ✅ 地理编码工具集成（高德地图API）
- ✅ 异步地点查询（GeocodeWorker后台线程）
- ✅ LRU缓存优化地理编码请求

### 文件统计
- 新增文件：9个
  - `theories/daliuren/__init__.py`
  - `theories/daliuren/constants.py` - 大六壬常量（~100行）
  - `theories/daliuren/calculator.py` - 大六壬计算器（~180行）
  - `theories/daliuren/theory.py` - 大六壬理论封装（~40行）
  - `theories/cezi/__init__.py`
  - `theories/cezi/constants.py` - 测字术常量（~150行）
  - `theories/cezi/calculator.py` - 测字术计算器（~330行）
  - `theories/cezi/theory.py` - 测字术理论封装（~100行）
  - `utils/amap_geocoder.py` - 高德地图地理编码工具（~200行）✨新增
- 修改文件：9个
  - `models.py` - 添加 initial_inquiry_time 字段
  - `api/prompts.py` - 更新所有模板包含起卦时间
  - `core/decision_engine.py` - 传递 initial_inquiry_time 到 LLM
  - `theories/__init__.py` - 注册大六壬和测字术
  - `ui/main_window.py` - GUI界面全面优化（~250行修改，完整支持所有UserInput字段 + 地点查询）✨
  - `.env.example` - 添加高德地图API配置项✨
  - `requirements.txt` - 添加requests依赖✨
  - `QUICKSTART.md` - 更新快速开始指南至v3.1
  - `CHANGELOG.md` - 文档更新
- 新增代码：约1100行
- 删除文件：3个（外层过时的README.md、PROJECT_SUMMARY.md、UPDATE_SUMMARY.md）

---

## v3.0 - 2024-12-30

### 🎉 重大更新

#### 新增术数理论
- ✅ **奇门遁甲模块** - 完整的奇门遁甲排盘系统
  - 时间验证机制（用户时间 vs 服务器时间）
  - 阴阳遁自动判断
  - 节气与局数计算
  - 九宫排布（九星、八门、八神）
  - 值符值使计算
  - 用神宫位分析
  - 吉凶方位判断
  - 时机建议与格局识别

- ✅ **紫微斗数模块** - 完整的紫微斗数排盘系统 ✨新增
  - 命宫身宫自动计算
  - 五局确定（水二、木三、金四、土五、火六）
  - 十四主星排布
  - 四化星安置（化禄、化权、化科、化忌）
  - 六吉星六煞星配置
  - 命主身主确定
  - 十二宫位完整排布
  - 性格事业财运分析
  - 支持农历阳历输入

现在系统支持**6个术数理论**：
1. 八字（命理类 - 基础）
2. 小六壬（快速类）
3. 梅花易数（快速类）
4. 六爻（占卜类 - 深度）
5. 奇门遁甲（深度类 - 择时）
6. 紫微斗数（命理类 - 基础）✨新增

#### 新增功能

**时间工具模块**
- 真太阳时计算（经度修正）
- 时间戳验证（防止时间作弊）
- 节气自动计算（支持24节气）
- 时辰转换（现代时间 → 传统十二时辰）
- 中国标准时间格式化
- `TimestampValidator` 类用于奇门遁甲时间验证

**农历转换模块（精确万年历）** ✨新增
- 阳历 ↔ 农历精确转换（支持1900-2100年）
- 基于寿星天文历算法
- 闰月自动处理
- 干支纪年月日时完整计算
- 生肖自动识别
- 月份日期中文名称
- 完整四柱八字支持
- 往返转换一致性保证
- 已整合到八字模块

**奇门遁甲精确起局**
- 用户声称时间与服务器时间对比（最大允许5分钟差异）
- 超过阈值则使用服务器时间并警告用户
- 确保起局时间准确性，防止时间操控

**冲突解决系统** ✨新增
- 4级冲突检测机制
  * Level 1: 完全一致（无需处理）
  * Level 2: 微小差异（简单平均）
  * Level 3: 显著差异（加权调和）
  * Level 4: 严重冲突（深度分析）
- 智能权重计算（基于置信度和冲突参与度）
- 自动冲突调和（加权平均算法）
- 冲突摘要生成
- 个性化建议系统
- 可信度评估机制

**配置验证系统** ✨新增
- 完整配置验证机制
  * 必需配置项检查
  * 配置类型验证
  * 配置值合理性验证
  * API密钥格式检查
  * 文件路径验证
- 默认值自动应用
- 友好的错误提示
- 警告信息提示
- 验证摘要输出

**日志系统** ✨新增
- 基于loguru的结构化日志
- 多级日志支持（DEBUG/INFO/WARNING/ERROR/CRITICAL）
- 多输出目标
  * 控制台彩色输出
  * 主日志文件（所有级别）
  * 错误日志文件（ERROR及以上）
  * 计算日志文件（独立记录）
- 自动日志轮转（按大小和时间）
- 日志压缩归档
- 性能指标记录
- API调用追踪
- 用户操作记录
- 冲突解决过程记录
- 计算过程详细记录

**启动初始化系统** ✨新增
- 统一的应用初始化流程
- 环境变量加载
- 配置文件加载与验证
- 日志系统自动初始化
- 启动状态反馈
- 优雅的错误处理

**八字神煞系统** ✨新增
- 完整的神煞查询与分析
- 12种重要神煞：
  * 贵人类：天乙贵人、文昌贵人、天德贵人、月德贵人
  * 吉星类：将星、金舆
  * 中性类：桃花、驿马、华盖
  * 凶星类：羊刃、劫煞、灾煞
- 神煞自动定位（年柱/月柱/日柱/时柱）
- 神煞吉凶评分系统
- 特殊神煞组合识别：
  * 天乙天德同现
  * 天月德合
  * 文昌入命
  * 桃花位置分析
  * 驿马入命
  * 羊刃入命
- 综合神煞影响分析
- 集成到八字计算主流程

**多API提供商支持** ✨新增
- 支持4个AI提供商：
  * Claude (Anthropic)
  * Gemini (Google)
  * Deepseek
  * Kimi (Moonshot)
- 智能故障转移机制：
  * 优先级链：claude > gemini > deepseek > kimi
  * 自动故障检测
  * 无缝切换到下一个可用API
  * 详细的日志记录
- 双模型验证系统：
  * 主副模型并发调用
  * 交叉验证结果
  * 提高分析可靠性
  * 可配置开关
- API调用性能追踪
- 完整的错误处理和降级策略

#### 技术改进
- ✅ 时间精度保障（真太阳时算法）
- ✅ 防作弊机制（时间戳验证）
- ✅ 节气查询优化
- ✅ 奇门遁甲复杂排盘逻辑
- ✅ 农历转换精确化（替换之前的近似算法）
- ✅ 八字模块支持农历输入
- ✅ 干支计算标准化
- ✅ 八字神煞完整实现（12种神煞） ✨
- ✅ 冲突解决具体逻辑实现（4级处理机制）
- ✅ 决策引擎集成冲突解决器
- ✅ 配置验证和日志系统集成 ✨
- ✅ 多API提供商支持（4个提供商） ✨
- ✅ 智能故障转移机制 ✨
- ✅ 双模型交叉验证系统 ✨

#### 使用方式
```bash
# 命令行示例（含时间验证）
python main.py

# 交互式
python main.py --interactive

# GUI界面
python gui.py
```

### 文件统计
- 新增文件：16个
  - `utils/time_utils.py` - 时间工具模块 (~350行)
  - `utils/lunar_calendar.py` - 农历转换模块 (~550行)
  - `utils/config_validator.py` - 配置验证模块 (~300行) ✨
  - `utils/logger.py` - 日志管理模块 (~350行) ✨
  - `utils/startup.py` - 启动初始化模块 (~200行) ✨
  - `theories/qimen/__init__.py`
  - `theories/qimen/constants.py` - 奇门遁甲常量
  - `theories/qimen/calculator.py` - 奇门遁甲计算器
  - `theories/qimen/theory.py` - 奇门遁甲理论封装
  - `theories/ziwei/__init__.py`
  - `theories/ziwei/constants.py` - 紫微斗数常量 (~250行)
  - `theories/ziwei/calculator.py` - 紫微斗数计算器 (~450行)
  - `theories/ziwei/theory.py` - 紫微斗数理论封装 (~120行)
  - `core/conflict_resolver.py` - 冲突解决器 (~550行) ✨
  - `tests/test_lunar_calendar.py` - 农历转换测试 (~250行)
  - `tests/test_conflict_resolver.py` - 冲突解决器测试 (~350行) ✨
- 新增代码：约5300行
- 修改文件：9个
  - `theories/__init__.py` - 注册奇门遁甲和紫微斗数理论
  - `theories/bazi/constants.py` - 添加神煞查询表（12种神煞） ✨
  - `theories/bazi/calculator.py` - 集成农历转换、添加神煞计算方法（~500行新增） ✨
  - `core/decision_engine.py` - 集成冲突解决器和日志系统 ✨
  - `main.py` - 集成启动初始化系统 ✨
  - `api/manager.py` - 重写为多API提供商管理器（~480行） ✨
  - `config.yaml` - 添加4个API配置和双模型验证开关 ✨
  - `utils/config_validator.py` - 更新API验证逻辑 ✨
  - `CHANGELOG.md` - 文档更新

---

## v2.0 - 2024-12-30

### 🎉 重大更新

#### 新增术数理论
- ✅ **梅花易数模块** - 支持多种起卦方式，体用分析，五行生克判断
- ✅ **六爻模块** - 数字起卦，装卦系统，用神分析

现在系统支持**4个术数理论**：
1. 八字（命理类）
2. 小六壬（快速类）
3. 梅花易数（快速类）✨新增
4. 六爻（占卜类）✨新增

#### 新增功能

**数据持久化**
- SQLite数据库集成
- 分析历史记录保存
- 数据加密存储（Fernet）
- 用户反馈管理
- 自动清理过期数据
- 统计信息查询

**PyQt6桌面界面**
- 图形化输入表单
- 实时分析进度显示
- 多线程异步处理
- 多标签页结果展示
- 报告保存功能

**测试套件**
- 八字模块单元测试
- 理论选择器单元测试
- 测试覆盖核心功能

#### 技术改进
- 所有理论自动注册
- 数据持久化支持加密
- PyQt6界面异步处理
- 完善的错误处理

#### 使用方式
```bash
# 命令行示例
python main.py

# 交互式
python main.py --interactive

# GUI界面（新增）
python gui.py
```

### 文件统计
- 新增文件：12个
- 新增代码：约1850行
- 测试文件：2个

---

## v1.0 - 2024-12-30（初始版本）

### 核心功能
- 八字模块（完整实现）
- 小六壬模块（完整实现）
- 决策引擎
- 理论选择算法
- API集成（Claude + Deepseek）
- 配置管理
- 命令行界面

### 项目初始化
- 项目结构搭建
- 数据模型定义
- API管理器
- Prompt模板库
- 文档编写（README、QUICKSTART）
